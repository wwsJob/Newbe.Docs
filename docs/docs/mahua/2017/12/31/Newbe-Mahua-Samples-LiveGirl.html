<!DOCTYPE html> <html lang="zh-cn"> <head> <meta charset="utf-8"> <meta name="msvalidate.01" content="71CCAD9D3DEDBA653F52D96EACF9ED56"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Newbe.Mahua.Samples.LiveGirl 操作定时任务 | Newbe便是新生，唯有不断蜕变才能焕然新生</title> <meta name="generator" content="Jekyll v3.6.2"/> <meta property="og:title" content="Newbe.Mahua.Samples.LiveGirl 操作定时任务"/> <meta name="author" content="Newbe"/> <meta property="og:locale" content="zh_cn"/> <meta name="description" content="B站直播姬！定时向群友通知群主何时进行女装直播的消息。"/> <meta property="og:description" content="B站直播姬！定时向群友通知群主何时进行女装直播的消息。"/> <link rel="canonical" href="http://www.newbe.pro/docs/mahua/2017/12/31/Newbe-Mahua-Samples-LiveGirl.html"/> <meta property="og:url" content="http://www.newbe.pro/docs/mahua/2017/12/31/Newbe-Mahua-Samples-LiveGirl.html"/> <meta property="og:site_name" content="Newbe便是新生，唯有不断蜕变才能焕然新生"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2017-12-31T00:00:00+00:00"/> <script type="application/ld+json">
{"datePublished":"2017-12-31T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.newbe.pro/docs/mahua/2017/12/31/Newbe-Mahua-Samples-LiveGirl.html"},"url":"http://www.newbe.pro/docs/mahua/2017/12/31/Newbe-Mahua-Samples-LiveGirl.html","author":{"@type":"Person","name":"Newbe"},"description":"B站直播姬！定时向群友通知群主何时进行女装直播的消息。","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://www.newbe.pro/assets/i/logo.png"},"name":"Newbe"},"headline":"Newbe.Mahua.Samples.LiveGirl 操作定时任务","dateModified":"2017-12-31T00:00:00+00:00","@type":"BlogPosting","@context":"http://schema.org"}</script> <link rel="alternate" type="application/rss+xml" title="Newbe便是新生，唯有不断蜕变才能焕然新生" href="http://www.newbe.pro /feed.xml "/> <meta name="keywords" content=""> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <meta name="renderer" content="webkit"> <meta http-equiv="Cache-Control" content="no-siteapp"/> <link rel="shortcut icon" type="image/x-icon" href="/assets/i/favicon.ico" media="screen"> <meta name="mobile-web-app-capable" content="yes"> <link rel="icon" sizes="192x192" href="/assets/i/favicon.ico"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="black"> <meta name="apple-mobile-web-app-title" content="Newbe"/> <link rel="apple-touch-icon-precomposed" href="/assets/i/favicon.ico"> <meta name="msapplication-TileImage" content="/assets/i/favicon.ico"> <meta name="msapplication-TileColor" content="#0e90d2"> <link rel="stylesheet" href="http://cdn.amazeui.org/amazeui/2.7.2/css/amazeui.min.css"> <link rel="stylesheet" href="/assets/css/app.css"> <link rel="stylesheet" href="/assets/css/rouge.css"> <link rel="stylesheet" href="/assets/css/newbe.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-100658571-2"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-100658571-2");</script> </head> <body> <header class="am-g am-g-fixed blog-fixed blog-text-center blog-header am-print-hide"> <div class="am-u-sm-8 am-u-sm-centered"> <img width="200" src="/assets/i/logo.png" alt="Amaze UI Logo"/> <h2 class="am-hide-sm-only">Newbe便是新生，唯有不断蜕变才能焕然新生。</h2> </div> </header> <nav class="am-g am-g-fixed blog-fixed blog-nav am-print-hide"> <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-success am-show-sm-only blog-button" data-am-collapse="{target: '#blog-collapse'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span></button> <div class="am-collapse am-topbar-collapse" id="blog-collapse"> <ul class="am-nav am-nav-pills am-topbar-nav"> <li class="am-active"><a href="/">首页</a></li> <li class="am-dropdown" data-am-dropdown=""> <a class="am-dropdown-toggle" data-am-dropdown-toggle="" href="javascript:;"> 源码 <span class="am-icon-caret-down"></span> </a> <ul class="am-dropdown-content"> <li><a href="https://gitee.com/yks/Newbe.Mahua.Framework" title="Newbe.Mahua" target="_blank">Newbe.Mahua（OSChina）</a></li> <li><a href="https://github.com/Newbe36524/Newbe.Mahua.Framework" title="Newbe.Mahua" target="_blank">Newbe.Mahua（Github）</a></li> </ul> </li> <li class="am-dropdown" data-am-dropdown=""> <a class="am-dropdown-toggle" data-am-dropdown-toggle="" href="javascript:;"> 教程 <span class="am-icon-caret-down"></span> </a> <ul class="am-dropdown-content"> <li><a href="/docs/mahua/2017/12/24/Newbe-Mahua-Navigations.html" title="Newbe.Mahua" target="_blank">Newbe.Mahua</a></li> </ul> </li> <li> <a href="/donate.html" title="借一步说话" target="_blank"> <span>借一步说话</span> <img src="/assets/i/crash.gif" alt="嗨起来" style="width:50px;"> </a> </li> <li><a href="https://jq.qq.com/?_wv=1027&k=4AMMCTx" title="技术交流群" target="_blank">技术交流群</a></li> <li><a href="#" title="麻花文库(Mahua Gallery)" onclick=" $('#pleaseWait').modal()">麻花(Mahua)插件中心</a></li> <li><a href="https://live.bilibili.com/7834872" title="直播码字" target="_blank"> <span id="liveStatus">直播码字</span> <img id="dancedog" src="/assets/i/dance-dog.gif" alt="嗨起来" style="height:50px;"> </a> </li> <li class="am-active"><a href="/resume.html" title="个人简历" target="_blank">个人简历</a></li> </ul> <div class="am-form-group"> <script type="text/javascript">!function(){document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E'));var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://znsv.baidu.com/customer_search/api/js?sid=4496900582148885024&plate_url="+encodeURIComponent(window.location.href)+"&t="+Math.ceil(new Date/36e5);var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();</script> </div> </div> </nav> <hr> <div class="am-modal am-modal-alert" tabindex="-1" id="pleaseWait"> <div class="am-modal-dialog"> <div class="am-modal-hd">即将上线</div> <div class="am-modal-bd"> 尽请期待！ </div> <div class="am-modal-footer"> <span class="am-modal-btn">确定</span> </div> </div> </div> <div class="am-g am-g-fixed blog-fixed blog-content"> <div class="am-u-md-8 am-u-sm-12"> <article class="am-article blog-article-p"> <div class="am-article-hd"> <h1 class="am-article-title blog-text-center">Newbe.Mahua.Samples.LiveGirl 操作定时任务</h1> <p class="am-article-meta blog-text-center"> <span><a href="#" class="blog-color">Docs and Mahua</a></span>- <span><a href="#">Newbe &nbsp;</a></span>- <span><a href="#">31 Dec 2017</a></span> <span class="am-print-hide"><a href="#" onclick="window.print();">【打印此页】</a></span> </p> </div> <div class="am-article-bd"> <div id="toc-container"> <table class="toc" id="toc"> <tbody> <tr> <td> <div id="toctitle"> <h2>目录</h2> </div> <ul> <li class="toc_level-1 toc_section-1"> <a href="#软硬条件"><span class="tocnumber">1</span> <span class="toctext">软硬条件</span></a> </li> <li class="toc_level-1 toc_section-2"> <a href="#业务逻辑"><span class="tocnumber">2</span> <span class="toctext">业务逻辑</span></a> </li> <li class="toc_level-1 toc_section-3"> <a href="#新建项目"><span class="tocnumber">3</span> <span class="toctext">新建项目</span></a> </li> <li class="toc_level-1 toc_section-4"> <a href="#业务逻辑实现"><span class="tocnumber">4</span> <span class="toctext">业务逻辑实现</span></a> </li> <li class="toc_level-1 toc_section-5"> <a href="#定时任务"><span class="tocnumber">5</span> <span class="toctext">定时任务</span></a> <ul> <li class="toc_level-2 toc_section-6"> <a href="#安装 nuget 包"><span class="tocnumber">5.1</span> <span class="toctext">安装 nuget 包</span></a> </li> <li class="toc_level-2 toc_section-7"> <a href="#插件启动时初始化Web服务"><span class="tocnumber">5.2</span> <span class="toctext">插件启动时初始化Web服务</span></a> </li> <li class="toc_level-2 toc_section-8"> <a href="#添加Hangfire初始化代码"><span class="tocnumber">5.3</span> <span class="toctext">添加Hangfire初始化代码</span></a> </li> <li class="toc_level-2 toc_section-9"> <a href="#实现IWebHost"><span class="tocnumber">5.4</span> <span class="toctext">实现IWebHost</span></a> </li> </ul> </li> <li class="toc_level-1 toc_section-10"> <a href="#实现直播姬"><span class="tocnumber">6</span> <span class="toctext">实现直播姬</span></a> <ul> <li class="toc_level-2 toc_section-11"> <a href="#获取直播间状态"><span class="tocnumber">6.1</span> <span class="toctext">获取直播间状态</span></a> </li> <li class="toc_level-2 toc_section-12"> <a href="#Livegirl"><span class="tocnumber">6.2</span> <span class="toctext">Livegirl</span></a> </li> </ul> </li> <li class="toc_level-1 toc_section-13"> <a href="#模块注册"><span class="tocnumber">7</span> <span class="toctext">模块注册</span></a> </li> <li class="toc_level-1 toc_section-14"> <a href="#集成测试"><span class="tocnumber">8</span> <span class="toctext">集成测试</span></a> </li> <li class="toc_level-1 toc_section-15"> <a href="#总结"><span class="tocnumber">9</span> <span class="toctext">总结</span></a> </li> <li class="toc_level-1 toc_section-16"> <a href="#教程链接"><span class="tocnumber">10</span> <span class="toctext">教程链接</span></a> </li> <li class="toc_level-1 toc_section-17"> <a href="#发布说明"><span class="tocnumber">11</span> <span class="toctext">发布说明</span></a> </li> </ul> </td> </tr> </tbody> </table> </div><p>B站直播姬！定时向群友通知群主何时进行女装直播的消息。</p> <h1 id="软硬条件">软硬条件</h1> <table> <thead> <tr> <th>名</th> <th>值</th> </tr> </thead> <tbody> <tr> <td>IDE</td> <td>VS2017.5</td> </tr> <tr> <td>Newbe.Mahua</td> <td>1.6</td> </tr> </tbody> </table> <h1 id="业务逻辑">业务逻辑</h1> <p>收到 “直播姬起飞” 的消息后，启动定时任务，每个整点时，检测B站直播间当前是否正在直播。</p> <p>如果正在直播，就向群发送 “群主正在女装” 的消息。</p> <p>收到 “直播姬降落” 的消息后，取消所有定时任务。</p> <p> <img src="/assets/i/20171231-001.png" alt="最终效果"/> </p> <h1 id="新建项目">新建项目</h1> <p>使用<code class="highlighter-rouge">Newbe.Mahua.Plugins.Template</code>模板创建项目，项目名称为<code class="highlighter-rouge">Newbe.Mahua.Samples.LiveGirl</code>。</p> <p>新建项目的详细细节，可以参照右侧链接内容：<a href="/docs/mahua/2017/12/16/Begin-First-Plugin-With-Mahua-In-v1.4.html#新建项目">新建项目</a></p> <h1 id="业务逻辑实现">业务逻辑实现</h1> <p>定义直播姬接口<code class="highlighter-rouge">ILiveGirl</code>，包含 “启动” 和 “停止” 两个基础方法。以便收到消息命令后对定时任务进行启停。</p> <p>为了提升多核CPU的利用率，相关接口都采用异步的方式进行定义。<del>实际上时为了让新手看不懂</del></p> <p>业务接口代码如下：</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// B站直播姬</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">ILivegirl</span>
    <span class="p">{</span>
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 启动</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">();</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 停止</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="n">Task</span> <span class="nf">StopAsnyc</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <p>在<code class="highlighter-rouge">MahuaEvents</code>下添加”好友消息接收事件”，并在事件内调用业务逻辑。实现代码如下：</p> <blockquote> <p>MahuaEvents文件夹是本SDK建议将事件放置的文件夹位置。也可以不接受建议而添加在其他地方。</p> </blockquote> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Newbe.Mahua.MahuaEvents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.MahuaEvents</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 来自好友的私聊消息接收事件</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PrivateMessageFromFriendReceivedMahuaEvent</span>
        <span class="p">:</span> <span class="n">IPrivateMessageFromFriendReceivedMahuaEvent</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILivegirl</span> <span class="n">_livegirl</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">PrivateMessageFromFriendReceivedMahuaEvent</span><span class="p">(</span>
            <span class="n">ILivegirl</span> <span class="n">livegirl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_livegirl</span> <span class="p">=</span> <span class="n">livegirl</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">ProcessFriendMessage</span><span class="p">(</span><span class="n">PrivateMessageFromFriendReceivedContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">FromQq</span> <span class="p">==</span> <span class="s">"472158246"</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">case</span> <span class="s">"直播姬起飞"</span><span class="p">:</span>
                        <span class="n">_livegirl</span><span class="p">.</span><span class="nf">StartAsync</span><span class="p">().</span><span class="nf">GetAwaiter</span><span class="p">().</span><span class="nf">GetResult</span><span class="p">();</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s">"直播姬降落"</span><span class="p">:</span>
                        <span class="n">_livegirl</span><span class="p">.</span><span class="nf">StopAsnyc</span><span class="p">().</span><span class="nf">GetAwaiter</span><span class="p">().</span><span class="nf">GetResult</span><span class="p">();</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <p>至此直播姬的启停便实现完毕。</p> <h1 id="定时任务">定时任务</h1> <p>定时任务的实现方式多种多样，可以利用<code class="highlighter-rouge">Timer</code>进行简单实现，也可以使用一些定时任务的类库进行实现。</p> <p>比较流行的有：<del>其实我也就知道两个</del></p> <ul> <li>Quartz.net</li> <li>Hangfire</li> </ul> <p>本例程将使用<code class="highlighter-rouge">Hangfire</code>来实现这一个功能。</p> <h2 id="安装 nuget 包">安装 nuget 包</h2> <p>安装以下 nuget 包：</p> <ul> <li>Hangfire.Core</li> <li>Hangfire.MemoryStorage</li> <li>Hangfire.Autofac</li> <li>Microsoft.Owin.Hosting</li> <li>Microsoft.Owin.Host.HttpListener</li> </ul> <p><code class="highlighter-rouge">Hangfire</code>相关内容是实现定时任务功能。</p> <p><code class="highlighter-rouge">Microsoft.Owin.*</code>则实现了在非IIS进程中托管Web服务的功能。</p> <h2 id="插件启动时初始化Web服务">插件启动时初始化Web服务</h2> <p>Hangfire 需要通过Web服务来展示当前的任务状态情况。</p> <p>添加 <code class="highlighter-rouge">IWebHost</code> 接口，以便在插件初始化时，初始化Web服务。</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Autofac</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">IWebHost</span>
    <span class="p">{</span>
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 启动Web服务</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;param name="baseUrl"&gt;&lt;/param&gt;</span>
        <span class="c1">/// &lt;param name="lifetimeScope"&gt;&lt;/param&gt;</span>
        <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">baseUrl</span><span class="p">,</span> <span class="n">ILifetimeScope</span> <span class="n">lifetimeScope</span><span class="p">);</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 停止</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <p>Web服务的初始化，需要在插件启动时进行调用。</p> <p>在<code class="highlighter-rouge">MahuaEvents</code>下添加”插件初始化事件”，并在事件内调用初始化。实现代码如下：</p> <blockquote> <p>MahuaEvents文件夹是本SDK建议将事件放置的文件夹位置。也可以不接受建议而添加在其他地方。</p> </blockquote> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Newbe.Mahua.MahuaEvents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.MahuaEvents</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 插件初始化事件</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">InitializationMahuaEvent</span>
        <span class="p">:</span> <span class="n">IInitializationMahuaEvent</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMahuaApi</span> <span class="n">_mahuaApi</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IWebHost</span> <span class="n">_webHost</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">InitializationMahuaEvent</span><span class="p">(</span>
            <span class="n">IMahuaApi</span> <span class="n">mahuaApi</span><span class="p">,</span>
            <span class="n">IWebHost</span> <span class="n">webHost</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_mahuaApi</span> <span class="p">=</span> <span class="n">mahuaApi</span><span class="p">;</span>
            <span class="n">_webHost</span> <span class="p">=</span> <span class="n">webHost</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Initialized</span><span class="p">(</span><span class="n">InitializedContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 在本地地址上启动Web服务，可以根据需求改变端口</span>
            <span class="n">_webHost</span><span class="p">.</span><span class="nf">StartAsync</span><span class="p">(</span><span class="s">"http://localhost:65238"</span><span class="p">,</span> <span class="n">_mahuaApi</span><span class="p">.</span><span class="nf">GetSourceContainer</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <h2 id="添加Hangfire初始化代码">添加Hangfire初始化代码</h2> <p>Owin 的启动入口是一个名为<code class="highlighter-rouge">Startup</code>的启动类，为了初始化<code class="highlighter-rouge">Hangfire</code>，则需要创建启动类，并初始化<code class="highlighter-rouge">Hangfire</code>。</p> <p>代码如下：</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Autofac</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Hangfire</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Hangfire.MemoryStorage</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Owin</span><span class="p">;</span>

<span class="c1">// 这是Startup的入口标记</span>
<span class="na">[assembly: OwinStartup(typeof(Newbe.Mahua.Samples.LiveGirl.Startup))]</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">ILifetimeScope</span> <span class="n">lifetimeScope</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 初始化Hangfire</span>
            <span class="kt">var</span> <span class="n">config</span> <span class="p">=</span> <span class="n">GlobalConfiguration</span><span class="p">.</span><span class="n">Configuration</span><span class="p">;</span>

            <span class="c1">// 使用内存存储任务，若有持久化任务的需求，可以根据Hangfire的文档使用数据库方式存储</span>
            <span class="n">config</span><span class="p">.</span><span class="nf">UseMemoryStorage</span><span class="p">();</span>

            <span class="c1">// 通过Autofac容器来实现任务的构建</span>
            <span class="n">config</span><span class="p">.</span><span class="nf">UseAutofacActivator</span><span class="p">(</span><span class="n">lifetimeScope</span><span class="p">);</span>

            <span class="c1">// 启用Hangfire的web界面</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">UseHangfireDashboard</span><span class="p">();</span>

            <span class="c1">// 初始化Hangfire服务</span>
            <span class="n">app</span><span class="p">.</span><span class="nf">UseHangfireServer</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <h2 id="实现IWebHost">实现IWebHost</h2> <p>上代码：</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Autofac</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Owin.Hosting</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services.Impl</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">OwinWebHost</span> <span class="p">:</span> <span class="n">IWebHost</span>
    <span class="p">{</span>
        <span class="c1">// 保存Web服务的实例</span>
        <span class="k">private</span> <span class="n">IDisposable</span> <span class="n">_webhost</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">baseUrl</span><span class="p">,</span> <span class="n">ILifetimeScope</span> <span class="n">lifetimeScope</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_webhost</span> <span class="p">=</span> <span class="n">WebApp</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="n">baseUrl</span><span class="p">,</span> <span class="n">app</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Startup</span><span class="p">().</span><span class="nf">Configuration</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">lifetimeScope</span><span class="p">));</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsync</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">_webhost</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <h1 id="实现直播姬">实现直播姬</h1> <p>基础设施已经在上一节完成，接下来就要实现直播姬和定时任务之间的调度代码。</p> <h2 id="获取直播间状态">获取直播间状态</h2> <p>直播间状态可以通过捕捉HTTP请求，看出如何实现。</p> <p>本例程，将引入 <code class="highlighter-rouge">RestSharp</code> nuget 包来实现HTTP请求。</p> <p>定义直播间接口<code class="highlighter-rouge">ILiveRoom</code>并添加实现类。</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="nc">ILiveRoom</span>
    <span class="p">{</span>
        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 获取直播间状态</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="c1">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="kt">bool</span> <span class="nf">IsOnLive</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">RestSharp</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services.Impl</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">LiveRoom</span> <span class="p">:</span> <span class="n">ILiveRoom</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">IsOnLive</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RestClient</span><span class="p">(</span><span class="s">"https://api.live.bilibili.com"</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">req</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RestRequest</span><span class="p">(</span><span class="s">"room/v1/Room/get_info?room_id=7834872&amp;from=room"</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">resp</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">Rootobject</span><span class="p">&gt;(</span><span class="n">req</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">IsSuccessful</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">live_status</span> <span class="p">==</span> <span class="m">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 可以使用VS中的 编辑-&gt;选择性粘贴-&gt;将JSON粘贴为类</span>
        <span class="c1">// 莫非不知道么ლ(′◉❥◉｀ლ)</span>
        <span class="k">public</span> <span class="k">class</span> <span class="nc">Rootobject</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">code</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">msg</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">message</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="n">Data</span> <span class="n">data</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">class</span> <span class="nc">Data</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">uid</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">live_status</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">area_id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">parent_area_id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">parent_area_name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">old_area_id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">background</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">title</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">user_cover</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">live_time</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">tags</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">is_anchor</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">room_silent_type</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">room_silent_level</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">room_silent_second</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">area_name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">pendants</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">area_pendants</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">verify</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <h2 id="Livegirl">Livegirl</h2> <p>来吧，终于可以实现直播姬了。</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Hangfire</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services.Impl</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Livegirl</span> <span class="p">:</span> <span class="n">ILivegirl</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">JobId</span> <span class="p">=</span> <span class="s">"jobid"</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMahuaApi</span> <span class="n">_mahuaApi</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILiveRoom</span> <span class="n">_liveRoom</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">Livegirl</span><span class="p">(</span>
            <span class="n">IMahuaApi</span> <span class="n">mahuaApi</span><span class="p">,</span>
            <span class="n">ILiveRoom</span> <span class="n">liveRoom</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_mahuaApi</span> <span class="p">=</span> <span class="n">mahuaApi</span><span class="p">;</span>
            <span class="n">_liveRoom</span> <span class="p">=</span> <span class="n">liveRoom</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StartAsync</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// 添加定时任务</span>
            <span class="c1">// 每个整点触发</span>
            <span class="n">RecurringJob</span><span class="p">.</span><span class="nf">AddOrUpdate</span><span class="p">(</span><span class="n">JobId</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nf">SendMessage</span><span class="p">(),</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">Cron</span><span class="p">.</span><span class="nf">HourInterval</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>

            <span class="c1">// 使用浏览器打开定时任务的地址</span>
            <span class="n">Process</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="s">"http://localhost:65238/hangfire/recurring"</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">Task</span> <span class="nf">StopAsnyc</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// 移除定时任务</span>
            <span class="n">RecurringJob</span><span class="p">.</span><span class="nf">RemoveIfExists</span><span class="p">(</span><span class="n">JobId</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">SendMessage</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// 如果直播间状态为正在直播，则发送消息</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_liveRoom</span><span class="p">.</span><span class="nf">IsOnLive</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">_mahuaApi</span><span class="p">.</span><span class="nf">SendGroupMessage</span><span class="p">(</span><span class="s">"610394020"</span><span class="p">,</span> <span class="s">"群主正在女装，前往观望？https://live.bilibili.com/7834872"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <h1 id="模块注册">模块注册</h1> <p>以上所有的接口与实现类与接口，都不要忘记在模块中进行注册，以下是<code class="highlighter-rouge">MahuaModule</code>的完整代码：</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Autofac</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newbe.Mahua.MahuaEvents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.MahuaEvents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl.Services.Impl</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Samples.LiveGirl</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Ioc容器注册</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MahuaModule</span> <span class="p">:</span> <span class="n">IMahuaModule</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">Module</span><span class="p">[]</span> <span class="nf">GetModules</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// 可以按照功能模块进行划分，此处可以改造为基于文件配置进行构造。实现模块化编程。</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">Module</span><span class="p">[]</span>
            <span class="p">{</span>
                <span class="k">new</span> <span class="nf">PluginModule</span><span class="p">(),</span>
                <span class="k">new</span> <span class="nf">MahuaEventsModule</span><span class="p">(),</span>
                <span class="k">new</span> <span class="nf">MyServiceModule</span><span class="p">(),</span>
            <span class="p">};</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 基本模块</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">private</span> <span class="k">class</span> <span class="nc">PluginModule</span> <span class="p">:</span> <span class="n">Module</span>
        <span class="p">{</span>
            <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Load</span><span class="p">(</span><span class="n">ContainerBuilder</span> <span class="n">builder</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">base</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
                <span class="c1">// 将实现类与接口的关系注入到Autofac的Ioc容器中。如果此处缺少注册将无法启动插件。</span>
                <span class="c1">// 注意！！！PluginInfo是插件运行必须注册的，其他内容则不是必要的！！！</span>
                <span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">PluginInfo</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IPluginInfo</span><span class="p">&gt;();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// &lt;see cref="IMahuaEvent"/&gt; 事件处理模块</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">private</span> <span class="k">class</span> <span class="nc">MahuaEventsModule</span> <span class="p">:</span> <span class="n">Module</span>
        <span class="p">{</span>
            <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Load</span><span class="p">(</span><span class="n">ContainerBuilder</span> <span class="n">builder</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">base</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
                <span class="c1">// 将需要监听的事件注册，若缺少此注册，则不会调用相关的实现类</span>
                <span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">InitializationMahuaEvent</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IInitializationMahuaEvent</span><span class="p">&gt;();</span>
                <span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">PrivateMessageFromFriendReceivedMahuaEvent</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IPrivateMessageFromFriendReceivedMahuaEvent</span><span class="p">&gt;();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">class</span> <span class="nc">MyServiceModule</span> <span class="p">:</span> <span class="n">Module</span>
        <span class="p">{</span>
            <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Load</span><span class="p">(</span><span class="n">ContainerBuilder</span> <span class="n">builder</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">base</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="n">builder</span><span class="p">);</span>
                <span class="c1">// 确保Web服务是单例</span>
                <span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">OwinWebHost</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IWebHost</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="nf">SingleInstance</span><span class="p">();</span>

                <span class="c1">// AsSelf是为了Hangfire能够初始化这个类</span>
                <span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">Livegirl</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">ILivegirl</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="nf">AsSelf</span><span class="p">();</span>
                <span class="n">builder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">&lt;</span><span class="n">LiveRoom</span><span class="p">&gt;()</span>
                    <span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">ILiveRoom</span><span class="p">&gt;();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <h1 id="集成测试">集成测试</h1> <p>万事具备，只欠生成。</p> <p>生成解决方案，运行<code class="highlighter-rouge">build.bat</code>，复制相关的 DLL 到对应的平台，向机器人发送消息，效果达成！</p> <p>以下是 CQP 平台的测试效果。<del>其实其他的没测试</del></p> <p> <img src="/assets/i/20171231-001.png" alt="最终效果"/> </p> <h1 id="总结">总结</h1> <p>一般的定时任务只需要使用<code class="highlighter-rouge">Timer</code>就能够实现了，引入<code class="highlighter-rouge">Hangfire</code>主要是为了体现框架本身的可扩展性。<del>分明是为了装逼</del></p> <p>HTTP的捕捉，可以使用<code class="highlighter-rouge">Fiddler</code>等Web调试工具实现。<del>又要自己学</del></p> <p>例程中写死的字符串，应当通过文件配置进行保存，可以自行改造。</p> <p>实例的项目代码，可以在源码仓库中的<code class="highlighter-rouge">Newbe.Mahua.Samples</code>解决方案下找到。</p> <p>=========================更多内容分割线=========================</p> <h1 id="教程链接">教程链接</h1> <p> <a href="/docs/mahua/2017/12/16/Begin-First-Plugin-With-Mahua-In-v1.4.html">开始第一个QQ机器人【适用于v1.4及以上】</a> </p> <p> <a href="/docs/mahua/2017/12/24/Newbe-Mahua-Administration.html">Newbe.Mahua 扩展设置中心</a> </p> <p> <a href="/docs/mahua/2017/12/25/Newbe-Mahua-Tests.html">Newbe.Mahua 测试与调试</a> </p> <p> <a href="/docs/mahua/2017/12/30/Newbe-Mahua-Samples-Sqlite.html">Newbe.Mahua.Samples.Sqlite SQLite操作实例</a> </p> <p> <a href="/docs/mahua/2017/12/31/Newbe-Mahua-Samples-LiveGirl.html">Newbe.Mahua.Samples.LiveGirl 操作定时任务</a> </p> <p> <a href="/docs/mahua/2018/01/07/Newbe-Mahua-ApiExtensions.html">Newbe.Mahua.Samples.ApiExtensions 对IMahuaApi进行扩展</a> </p> <h1 id="发布说明">发布说明</h1> <p> <a href="/docs/mahua/releasenodes/2018/01/07/Release-Notes-1-7-0.html">Newbe.Mahua 1.7.0 支持API扩展</a> </p> <p> <a href="/docs/mahua/releasenodes/2017/12/30/Release-Notes-1-6-0.html">Newbe.Mahua 1.6.0 开发便利性提升</a> </p> </div> </article> <hr class="am-print-hide"/> <div class="am-g blog-article-widget blog-article-margin am-print-hide"> <div class="am-u-lg-4 am-u-md-5 am-u-sm-7 am-u-sm-centered blog-text-center"> <span class="am-icon-tags"> &nbsp;</span> <a href="#">Mahua</a> <a href="#">SDK</a> <hr> <a href="http://wpa.qq.com/msgrd?v=3&uin=472158246&site=qq&menu=yes" target="_blank"><span class="am-icon-qq am-icon-fw am-primary blog-icon blog-icon"></span></a> <a href="https://github.com/Newbe36524" target="_blank"><span class="am-icon-github am-icon-fw blog-icon blog-icon"></span></a> <a href="http://weibo.com/newbe36524" target="_blank"><span class="am-icon-weibo am-icon-fw blog-icon blog-icon"></span></a> <a href="http://git.oschina.net/yks" target="_blank"><span class="am-icon-reddit am-icon-fw blog-icon blog-icon"></span></a> </div> </div> </div> <div class="am-u-md-4 am-u-sm-12 blog-sidebar am=print-hide"> <div class="blog-sidebar-widget blog-bor am-hide-sm-only" id="contentsContainer"> <table id="contentsDiv" style="text-align:left"></table> </div> </div> </div> <div class="am-g am-g-fixed blog-fixed am-print-hide"> <div id="SOHUCS" sid="/docs/mahua/2017/12/31/Newbe-Mahua-Samples-LiveGirl"></div> <script type="text/javascript">!function(){var t="cytpQ7o5c",e="prod_d85e287b64f481565533e63604638674";(window.innerWidth||document.documentElement.clientWidth)<960?window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id='+t+"&conf="+e+'" />'):function(t,e){var n=document.getElementsByTagName("head")[0]||document.head||document.documentElement,a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("charset","UTF-8"),a.setAttribute("src",t),"function"==typeof e&&(window.attachEvent?a.onreadystatechange=function(){var t=a.readyState;"loaded"!==t&&"complete"!==t||(a.onreadystatechange=null,e())}:a.onload=e),n.appendChild(a)}("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:t,conf:e})})}();</script> </div> <div data-am-widget="gotop" class="am-gotop am-gotop-fixed am-print-hide"> <a href="#top" title="回到顶部"> <span class="am-gotop-title">回到顶部</span> <i class="am-gotop-icon am-icon-chevron-up"></i> </a> </div> <footer class="blog-footer am-print-hide"> <div class="am-g am-g-fixed blog-fixed am-u-sm-centered blog-footer-padding"> <div class="am-u-sm-12 am-u-md-4- am-u-lg-4"> <h3>友情链接</h3> <a target="_blank" href="https://traceless.site/"><p class="am-text-sm">.Net全栈工程师traceless</p></a> <a target="_blank" href="https://my.suwaworld.xyz/"><p class="am-text-sm">神秘の领域SuwaWorld</p></a> <a target="_blank" href="http://i.qmrobot.com/"><p class="am-text-sm">全能大佬Byboy</p></a> </div> <div class="am-u-sm-12 am-u-md-4- am-u-lg-4"> <h3>社交账号</h3> <p> <a href="http://wpa.qq.com/msgrd?v=3&uin=472158246&site=qq&menu=yes" target="_blank"><span class="am-icon-qq am-icon-fw am-primary blog-icon blog-icon"></span></a> <a href="https://github.com/Newbe36524" target="_blank"><span class="am-icon-github am-icon-fw blog-icon blog-icon"></span></a> <a href="http://weibo.com/newbe36524" target="_blank"><span class="am-icon-weibo am-icon-fw blog-icon blog-icon"></span></a> <a href="http://git.oschina.net/yks" target="_blank"><span class="am-icon-reddit am-icon-fw blog-icon blog-icon"></span></a> </p> <h3>Bio</h3> <p>Newbe便是新生，唯有不断蜕变才能焕然新生。</p> </div> <div class="am-u-sm-12 am-u-md-4- am-u-lg-4"> <h1>我们站在巨人的肩膀上</h1> <h3>Heroes</h3> <p> <ul> <li>amazeui</li> <li>amwiki</li> <li>jekyll</li> <li>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></li> <li>...</li> </ul> </p> </div> </div> <div class="blog-text-center"> © 2018 Newbe <a href="http://www.miitbeian.gov.cn" title="闽ICP备18002256号" target="_blank">闽ICP备18002256号</a> <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=35010202000749"> <img src="https://ss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/img/icon-police.png?v=md5"/> 闽公网安备 35010202000749号 </a> </div> </footer> <div class="am-modal am-modal-confirm" tabindex="-1" id="live-confirm"> <div class="am-modal-dialog"> <div class="am-modal-hd">b站直播</div> <div class="am-modal-bd"> 听说正在直播码字，要不要前去帮忙刷一下人气？ </div> <div class="am-modal-footer"> <span class="am-modal-btn am-btn-primary" data-am-modal-cancel>滚蛋</span> <span class="am-modal-btn" data-am-modal-confirm>好的</span> </div> </div> </div> <!--[if (gte IE 9)|!(IE)]><!--> <script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script> <!--<![endif]--> <!--[if lte IE 8 ]><script src="https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script> <script src="https://cdn.bootcss.com/modernizr/2.8.3/modernizr.min.js"></script> <script src="http://cdn.amazeui.org/amazeui/2.7.2/js/amazeui.ie8polyfill.min.js"></script><![endif]--> <script src="https://cdn.bootcss.com/jquery.pin/1.0.1/jquery.pin.js"></script> <script src="http://cdn.amazeui.org/amazeui/2.7.2/js/amazeui.min.js"></script> <script src="/assets/js/newbe/baidutuisong.js" type="text/javascript"></script> <script type="text/javascript">$(function(){$(".am-article").find("table").addClass("am-table am-table-striped am-table-hover"),$("del").attr("title","\u4f60\u77e5\u9053\u7684\u592a\u591a\u4e86\uff01"),function(){var t=!0;window.setInterval(function(){t||$.get("http://pianzide1117.oicp.net:12821/api/beesite/status").done(function(e){e?($("#live-confirm").modal({relatedTarget:this,onConfirm:function(){window.open("https://live.bilibili.com/7834872")},onCancel:function(){}}),$("#liveStatus").html("\u6b63\u5728\u76f4\u64ad\u7801\u5b57")):($("#liveStatus").html("\u8fd9\u4f1a\u513f\u6ca1\u6709\u76f4\u64ad"),$("#dancedog").hide()),t=!0}).error(function(){$("#liveStatus").html("\u8fd9\u4f1a\u513f\u6ca1\u6709\u76f4\u64ad"),$("#dancedog").hide()})},2e3)}(),function(){$("#contentsDiv").html($("#toc").html()),$("#toc").remove(),$("#contentsContainer").pin({containerSelector:".blog-content"})}()});</script> </body> </html>

