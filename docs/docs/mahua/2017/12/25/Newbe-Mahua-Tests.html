<!DOCTYPE html> <html lang="zh-cn"> <head> <meta charset="utf-8"> <meta name="msvalidate.01" content="71CCAD9D3DEDBA653F52D96EACF9ED56"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Newbe.Mahua 测试与调试 | Newbe</title> <meta name="generator" content="Jekyll v3.6.2"/> <meta property="og:title" content="Newbe.Mahua 测试与调试"/> <meta name="author" content="Newbe"/> <meta property="og:locale" content="zh_cn"/> <meta name="description" content="测试与调试是开发过程当中不可缺少的环节。本教程将通过对”鹦鹉学舌”插件对”如何测试与调试Newbe.Mahua”."/> <meta property="og:description" content="测试与调试是开发过程当中不可缺少的环节。本教程将通过对”鹦鹉学舌”插件对”如何测试与调试Newbe.Mahua”."/> <link rel="canonical" href="http://www.newbe.pro/docs/mahua/2017/12/25/Newbe-Mahua-Tests.html"/> <meta property="og:url" content="http://www.newbe.pro/docs/mahua/2017/12/25/Newbe-Mahua-Tests.html"/> <meta property="og:site_name" content="Newbe"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2017-12-25T00:00:00+00:00"/> <script type="application/ld+json">
{"dateModified":"2017-12-25T00:00:00+00:00","datePublished":"2017-12-25T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.newbe.pro/docs/mahua/2017/12/25/Newbe-Mahua-Tests.html"},"url":"http://www.newbe.pro/docs/mahua/2017/12/25/Newbe-Mahua-Tests.html","author":{"@type":"Person","name":"Newbe"},"description":"测试与调试是开发过程当中不可缺少的环节。本教程将通过对”鹦鹉学舌”插件对”如何测试与调试Newbe.Mahua”.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://www.newbe.pro/assets/i/logo.png"},"name":"Newbe"},"headline":"Newbe.Mahua 测试与调试","@type":"BlogPosting","@context":"http://schema.org"}</script> <link rel="alternate" type="application/rss+xml" title="Newbe" href="http://www.newbe.pro /feed.xml "/> <meta name="keywords" content=""> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <meta name="renderer" content="webkit"> <meta http-equiv="Cache-Control" content="no-siteapp"/> <link rel="shortcut icon" type="image/x-icon" href="/assets/i/favicon.ico" media="screen"> <meta name="mobile-web-app-capable" content="yes"> <link rel="icon" sizes="192x192" href="/assets/i/favicon.ico"> <meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="black"> <meta name="apple-mobile-web-app-title" content="Newbe"/> <link rel="apple-touch-icon-precomposed" href="/assets/i/favicon.ico"> <meta name="msapplication-TileImage" content="/assets/i/favicon.ico"> <meta name="msapplication-TileColor" content="#0e90d2"> <link rel="stylesheet" href="http://cdn.amazeui.org/amazeui/2.7.2/css/amazeui.min.css"> <link rel="stylesheet" href="/assets/css/app.css"> <link rel="stylesheet" href="/assets/css/rouge.css"> <link rel="stylesheet" href="/assets/css/newbe.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-100658571-2"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-100658571-2");</script> </head> <body> <header class="am-g am-g-fixed blog-fixed blog-text-center blog-header am-print-hide"> <div class="am-u-sm-8 am-u-sm-centered"> <img width="200" src="/assets/i/logo.png" alt="Amaze UI Logo"/> <h2 class="am-hide-sm-only">Newbe便是新生，唯有不断蜕变才能焕然新生。</h2> </div> </header> <nav class="am-g am-g-fixed blog-fixed blog-nav am-print-hide"> <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-success am-show-sm-only blog-button" data-am-collapse="{target: '#blog-collapse'}"><span class="am-sr-only">导航切换</span> <span class="am-icon-bars"></span></button> <div class="am-collapse am-topbar-collapse" id="blog-collapse"> <ul class="am-nav am-nav-pills am-topbar-nav"> <li class="am-active"><a href="/">首页</a></li> <li class="am-dropdown" data-am-dropdown=""> <a class="am-dropdown-toggle" data-am-dropdown-toggle="" href="javascript:;"> 源码 <span class="am-icon-caret-down"></span> </a> <ul class="am-dropdown-content"> <li><a href="https://gitee.com/yks/Newbe.Mahua.Framework" title="Newbe.Mahua" target="_blank">Newbe.Mahua（OSChina）</a></li> <li><a href="https://github.com/Newbe36524/Newbe.Mahua.Framework" title="Newbe.Mahua" target="_blank">Newbe.Mahua（Github）</a></li> </ul> </li> <li class="am-dropdown" data-am-dropdown=""> <a class="am-dropdown-toggle" data-am-dropdown-toggle="" href="javascript:;"> 教程 <span class="am-icon-caret-down"></span> </a> <ul class="am-dropdown-content"> <li><a href="/docs/mahua/2017/12/24/Newbe-Mahua-Navigations.html" title="Newbe.Mahua" target="_blank">Newbe.Mahua</a></li> </ul> </li> <li> <a href="/donate.html" title="借一步说话" target="_blank"> <span>借一步说话</span> <img src="/assets/i/crash.gif" alt="嗨起来" style="width:50px;"> </a> </li> <li><a href="https://jq.qq.com/?_wv=1027&k=4AMMCTx" title="技术交流群" target="_blank">技术交流群</a></li> <li><a href="#" title="麻花文库(Mahua Gallery)" onclick=" $('#pleaseWait').modal()">麻花(Mahua)插件中心</a></li> <li><a href="https://live.bilibili.com/7834872" title="直播码字" target="_blank"> <span id="liveStatus">直播码字</span> <img id="dancedog" src="/assets/i/dance-dog.gif" alt="嗨起来" style="height:50px;"> </a> </li> <li class="am-active"><a href="/resume.html" title="个人简历" target="_blank">个人简历</a></li> </ul> <div class="am-form-group"> <script type="text/javascript">!function(){document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E'));var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://znsv.baidu.com/customer_search/api/js?sid=4496900582148885024&plate_url="+encodeURIComponent(window.location.href)+"&t="+Math.ceil(new Date/36e5);var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();</script> </div> </div> </nav> <hr> <div class="am-modal am-modal-alert" tabindex="-1" id="pleaseWait"> <div class="am-modal-dialog"> <div class="am-modal-hd">即将上线</div> <div class="am-modal-bd"> 尽请期待！ </div> <div class="am-modal-footer"> <span class="am-modal-btn">确定</span> </div> </div> </div> <div class="am-g am-g-fixed blog-fixed blog-content"> <div class="am-u-md-8 am-u-sm-12"> <article class="am-article blog-article-p"> <div class="am-article-hd"> <h1 class="am-article-title blog-text-center">Newbe.Mahua 测试与调试</h1> <p class="am-article-meta blog-text-center"> <span><a href="#" class="blog-color">Docs and Mahua</a></span>- <span><a href="#">Newbe &nbsp;</a></span>- <span><a href="#">25 Dec 2017</a></span> <span class="am-print-hide"><a href="#" onclick="window.print();">【打印此页】</a></span> </p> </div> <div class="am-article-bd"> <div id="toc-container"> <table class="toc" id="toc"> <tbody> <tr> <td> <div id="toctitle"> <h2>目录</h2> </div> <ul> <li class="toc_level-1 toc_section-1"> <a href="#测试"><span class="tocnumber">1</span> <span class="toctext">测试</span></a> <ul> <li class="toc_level-2 toc_section-2"> <a href="#新建测试项目"><span class="tocnumber">1.1</span> <span class="toctext">新建测试项目</span></a> </li> <li class="toc_level-2 toc_section-3"> <a href="#引入测试框架"><span class="tocnumber">1.2</span> <span class="toctext">引入测试框架</span></a> </li> <li class="toc_level-2 toc_section-4"> <a href="#添加单元测试代码"><span class="tocnumber">1.3</span> <span class="toctext">添加单元测试代码</span></a> </li> <li class="toc_level-2 toc_section-5"> <a href="#运行测试代码"><span class="tocnumber">1.4</span> <span class="toctext">运行测试代码</span></a> </li> <li class="toc_level-2 toc_section-6"> <a href="#需求变化"><span class="tocnumber">1.5</span> <span class="toctext">需求变化</span></a> </li> <li class="toc_level-2 toc_section-7"> <a href="#最后"><span class="tocnumber">1.6</span> <span class="toctext">最后</span></a> </li> </ul> </li> <li class="toc_level-1 toc_section-8"> <a href="#调试"><span class="tocnumber">2</span> <span class="toctext">调试</span></a> <ul> <li class="toc_level-2 toc_section-9"> <a href="#构建"><span class="tocnumber">2.1</span> <span class="toctext">构建</span></a> </li> <li class="toc_level-2 toc_section-10"> <a href="#复制"><span class="tocnumber">2.2</span> <span class="toctext">复制</span></a> </li> <li class="toc_level-2 toc_section-11"> <a href="#启动调试"><span class="tocnumber">2.3</span> <span class="toctext">启动调试</span></a> </li> <li class="toc_level-2 toc_section-12"> <a href="#调试框架源码"><span class="tocnumber">2.4</span> <span class="toctext">调试框架源码</span></a> </li> </ul> </li> <li class="toc_level-1 toc_section-13"> <a href="#教程链接"><span class="tocnumber">3</span> <span class="toctext">教程链接</span></a> </li> <li class="toc_level-1 toc_section-14"> <a href="#发布说明"><span class="tocnumber">4</span> <span class="toctext">发布说明</span></a> </li> </ul> </td> </tr> </tbody> </table> </div><p>测试与调试是开发过程当中不可缺少的环节。本教程将通过对”鹦鹉学舌”插件对”如何测试与调试Newbe.Mahua”.</p> <h1 id="测试">测试</h1> <p>测试分类多种多样，其中，”单元测试”是最开始的细粒度测试。</p> <p>掌握单元测试的技能，将会在使用Newbe.Mahua进行开发时无往不利的成功秘诀。</p> <p>本教程将使用VS2017作为开发IDE进行演示。</p> <h2 id="新建测试项目">新建测试项目</h2> <p> <img src="/assets/i/20171225-001.png" alt="新建测试项目"/> </p> <h2 id="引入测试框架">引入测试框架</h2> <p>.Net测试框架众多，主流的有MSTest、NUnit和XUnit。本教程选择XUnit进行演示。</p> <p>通过 nuget 安装以下包，全部安装最新版本即可：</p> <ul> <li>xunit</li> <li>xunit.runner.visualstudio</li> <li>FluentAssertions</li> <li>Autofac.Extras.Moq</li> </ul> <p>可以不用先了解每个包时什么作用，看了代码，自然就会清楚。</p> <h2 id="添加单元测试代码">添加单元测试代码</h2> <p>先看一下需要测试的”鹦鹉学舌”插件的核心逻辑，将消息回发给消息发送者。</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Newbe.Mahua.MahuaEvents</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Plugins.Parrot.MahuaEvents</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 来自好友的私聊消息接收事件</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PrivateMessageFromFriendReceivedMahuaEvent</span>
        <span class="p">:</span> <span class="n">IPrivateMessageFromFriendReceivedMahuaEvent</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMahuaApi</span> <span class="n">_mahuaApi</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">PrivateMessageFromFriendReceivedMahuaEvent</span><span class="p">(</span>
            <span class="n">IMahuaApi</span> <span class="n">mahuaApi</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_mahuaApi</span> <span class="p">=</span> <span class="n">mahuaApi</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">ProcessFriendMessage</span><span class="p">(</span><span class="n">PrivateMessageFromFriendReceivedContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 将好友信息会发给好友</span>
            <span class="n">_mahuaApi</span><span class="p">.</span><span class="nf">SendPrivateMessage</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">FromQq</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <p>通过项目引用，引用”Newbe.Mahua.Plugins.Parrot”项目。</p> <p>在新建的测试项目”Newbe.Mahua.Plugins.Parrot.Tests”中新建一个类”ParrotTest”，并填写以下代码：</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Autofac.Extras.Moq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">FluentAssertions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newbe.Mahua.MahuaEvents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newbe.Mahua.Plugins.Parrot.MahuaEvents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit.Abstractions</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Plugins.Parrot.Tests</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ParrotTest</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITestOutputHelper</span> <span class="n">_testOutputHelper</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">ParrotTest</span><span class="p">(</span><span class="n">ITestOutputHelper</span> <span class="n">testOutputHelper</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 这是xunit特有的信息输出方法，其他框架可以使用Console.Writeline</span>
            <span class="n">_testOutputHelper</span> <span class="p">=</span> <span class="n">testOutputHelper</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">Fact</span><span class="p">(</span><span class="n">DisplayName</span> <span class="p">=</span> <span class="s">"将消息回发给消息发送者"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Test</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// 一般的单元测试都分为三个部分 Arrange(准备) Action(执行) 和 Assert(断言)</span>
            <span class="c1">// Arrange 对单元测试中需要测试的准备参数进行初始化</span>
            <span class="c1">// Action 执行需要测试的逻辑</span>
            <span class="c1">// Assert 对测试结果是否正确进行判断</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">mocker</span> <span class="p">=</span> <span class="n">AutoMock</span><span class="p">.</span><span class="nf">GetStrict</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="c1">// Moq的参数，确定在整个单元测试结束之后，所有被模拟的方法都已经被执行。</span>
                <span class="n">mocker</span><span class="p">.</span><span class="n">VerifyAll</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

                <span class="err">#</span><span class="n">region</span> <span class="n">Arrange</span>

                <span class="c1">// 生成一个IMahuaApi的实现，这个实现的所有方法都是没有实现的，需要进一步填充</span>
                <span class="kt">var</span> <span class="n">mahuaApi</span> <span class="p">=</span> <span class="n">mocker</span><span class="p">.</span><span class="n">Mock</span><span class="p">&lt;</span><span class="n">IMahuaApi</span><span class="p">&gt;();</span>

                <span class="c1">// 用来记录消息是否已经发送的变量，为了在断言中使用</span>
                <span class="kt">var</span> <span class="n">msgSend</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

                <span class="c1">// 对MahuaApi中的SendPrivateMessage方法进行模拟</span>
                <span class="c1">// 当调用参数是“472158246”和“呵呵哒”时，调用xunit帮助类在控制台输出消息</span>
                <span class="c1">// 并设置变量msgSend为true  表示，消息确实已经回发了</span>
                <span class="n">mahuaApi</span>
                    <span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">SendPrivateMessage</span><span class="p">(</span><span class="s">"472158246"</span><span class="p">,</span> <span class="s">"呵呵哒"</span><span class="p">))</span>
                    <span class="p">.</span><span class="n">Callback</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;((</span><span class="n">qq</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="p">=&gt;</span>
                    <span class="p">{</span>
                        <span class="n">_testOutputHelper</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"测试将消息发送给</span><span class="p">{</span><span class="n">qq</span><span class="p">}</span><span class="s">,消息是</span><span class="p">{</span><span class="n">msg</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                        <span class="n">msgSend</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="p">});</span>

                <span class="err">#</span><span class="n">endregion</span>

                <span class="err">#</span><span class="n">region</span> <span class="n">Action</span>

                <span class="c1">//创建需要测试的类，由于使用了Autofac.Extras.Moq，构造函数注入的过程会自动执行</span>
                <span class="n">IPrivateMessageFromFriendReceivedMahuaEvent</span> <span class="n">@event</span> <span class="p">=</span>
                    <span class="n">mocker</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">PrivateMessageFromFriendReceivedMahuaEvent</span><span class="p">&gt;();</span>

                <span class="c1">// 模拟某人向机器人发送了消息</span>
                <span class="n">@event</span><span class="p">.</span><span class="nf">ProcessFriendMessage</span><span class="p">(</span><span class="k">new</span> <span class="n">PrivateMessageFromFriendReceivedContext</span>
                <span class="p">{</span>
                    <span class="n">FromQq</span> <span class="p">=</span> <span class="s">"472158246"</span><span class="p">,</span>
                    <span class="n">Message</span> <span class="p">=</span> <span class="s">"呵呵哒"</span><span class="p">,</span>
                    <span class="n">SendTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span>
                <span class="p">});</span>

                <span class="err">#</span><span class="n">endregion</span>

                <span class="err">#</span><span class="n">region</span> <span class="n">Assert</span>

                <span class="c1">// 根据这个变量判断 机器人是否成功回发了消息</span>
                <span class="n">msgSend</span><span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">BeTrue</span><span class="p">();</span>

                <span class="err">#</span><span class="n">endregion</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <p>通过阅读代码的注释，相信真正的勇士已经领会了其中的奥义。</p> <h2 id="运行测试代码">运行测试代码</h2> <p> <img src="/assets/i/20171225-002.png" alt="运行测试"/> </p> <p> <strong>来吧！真正的勇士，就绿了它们！</strong> </p> <h2 id="需求变化">需求变化</h2> <p>需求变了，只有消息当中有”收到回复”这个字符串，那么才需要回发，并且要删除其中的”收到回复”字符串。</p> <p>在测试项目新加一个实现类，来实现上面的业务逻辑。</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Newbe.Mahua.MahuaEvents</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Plugins.Parrot.Tests</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// 只有包含收到回复，才需要回复</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">PrivateMessageFromFriendReceivedMahuaEventV2</span>
        <span class="p">:</span> <span class="n">IPrivateMessageFromFriendReceivedMahuaEvent</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMahuaApi</span> <span class="n">_mahuaApi</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">PrivateMessageFromFriendReceivedMahuaEventV2</span><span class="p">(</span>
            <span class="n">IMahuaApi</span> <span class="n">mahuaApi</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_mahuaApi</span> <span class="p">=</span> <span class="n">mahuaApi</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">ProcessFriendMessage</span><span class="p">(</span><span class="n">PrivateMessageFromFriendReceivedContext</span> <span class="n">context</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">Message</span><span class="p">?.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"收到回复"</span><span class="p">)</span> <span class="p">==</span> <span class="k">true</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">msg</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"收到回复"</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">);</span>
                <span class="n">_mahuaApi</span><span class="p">.</span><span class="nf">SendPrivateMessage</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">FromQq</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <p>显然，这个业务逻辑，至少需要两个单元测试。一个测试的消息中包含”收到回复”，另一个则不包含。</p> <p>由此，新建”ParrotTestV2”类，并填写以下代码：</p> <div class="language-csharp highlighter-rouge"> <div class="highlight"> <pre class="highlight">
      <code>
<span class="k">using</span> <span class="nn">Autofac.Extras.Moq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">FluentAssertions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Newbe.Mahua.MahuaEvents</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit.Abstractions</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Newbe.Mahua.Plugins.Parrot.Tests</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ParrotTestV2</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITestOutputHelper</span> <span class="n">_testOutputHelper</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">ParrotTestV2</span><span class="p">(</span><span class="n">ITestOutputHelper</span> <span class="n">testOutputHelper</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_testOutputHelper</span> <span class="p">=</span> <span class="n">testOutputHelper</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">Fact</span><span class="p">(</span><span class="n">DisplayName</span> <span class="p">=</span> <span class="s">"消息包含“收到回复”"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Test1</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">mocker</span> <span class="p">=</span> <span class="n">AutoMock</span><span class="p">.</span><span class="nf">GetStrict</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">mocker</span><span class="p">.</span><span class="n">VerifyAll</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="kt">var</span> <span class="n">mahuaApi</span> <span class="p">=</span> <span class="n">mocker</span><span class="p">.</span><span class="n">Mock</span><span class="p">&lt;</span><span class="n">IMahuaApi</span><span class="p">&gt;();</span>
                <span class="kt">var</span> <span class="n">msgSend</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="n">mahuaApi</span>
                    <span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">SendPrivateMessage</span><span class="p">(</span><span class="s">"472158246"</span><span class="p">,</span> <span class="s">"请马上捐款"</span><span class="p">))</span>
                    <span class="p">.</span><span class="n">Callback</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;((</span><span class="n">qq</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="p">=&gt;</span>
                    <span class="p">{</span>
                        <span class="n">_testOutputHelper</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"测试将消息发送给</span><span class="p">{</span><span class="n">qq</span><span class="p">}</span><span class="s">,消息是</span><span class="p">{</span><span class="n">msg</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
                        <span class="n">msgSend</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="p">});</span>

                <span class="c1">// 这里使用的是V2</span>
                <span class="n">IPrivateMessageFromFriendReceivedMahuaEvent</span> <span class="n">@event</span> <span class="p">=</span>
                    <span class="n">mocker</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">PrivateMessageFromFriendReceivedMahuaEventV2</span><span class="p">&gt;();</span>
                <span class="n">@event</span><span class="p">.</span><span class="nf">ProcessFriendMessage</span><span class="p">(</span><span class="k">new</span> <span class="n">PrivateMessageFromFriendReceivedContext</span>
                <span class="p">{</span>
                    <span class="n">FromQq</span> <span class="p">=</span> <span class="s">"472158246"</span><span class="p">,</span>
                    <span class="n">Message</span> <span class="p">=</span> <span class="s">"请马上捐款收到回复"</span><span class="p">,</span>
                    <span class="n">SendTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span>
                <span class="p">});</span>

                <span class="c1">// 注意，这里是true</span>
                <span class="n">msgSend</span><span class="p">.</span><span class="nf">Should</span><span class="p">().</span><span class="nf">BeTrue</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="nf">Fact</span><span class="p">(</span><span class="n">DisplayName</span> <span class="p">=</span> <span class="s">"消息不包含“收到回复”"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">Test2</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">mocker</span> <span class="p">=</span> <span class="n">AutoMock</span><span class="p">.</span><span class="nf">GetStrict</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">mocker</span><span class="p">.</span><span class="n">VerifyAll</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

                <span class="c1">// 因为我们确定不会调用IMahuaApi，所以不需要Mock</span>

                <span class="c1">// 这里使用的是V2</span>
                <span class="n">IPrivateMessageFromFriendReceivedMahuaEvent</span> <span class="n">@event</span> <span class="p">=</span>
                    <span class="n">mocker</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">PrivateMessageFromFriendReceivedMahuaEventV2</span><span class="p">&gt;();</span>
                <span class="n">@event</span><span class="p">.</span><span class="nf">ProcessFriendMessage</span><span class="p">(</span><span class="k">new</span> <span class="n">PrivateMessageFromFriendReceivedContext</span>
                <span class="p">{</span>
                    <span class="n">FromQq</span> <span class="p">=</span> <span class="s">"472158246"</span><span class="p">,</span>
                    <span class="n">Message</span> <span class="p">=</span> <span class="s">"呵呵哒"</span><span class="p">,</span>
                    <span class="n">SendTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code>
    </pre> </div> </div> <p>自己手动尝试的过程中可能会出现，没出现”绿”的问题。不要放弃，要么测试错了，要么业务逻辑错误。电脑是不会错的。</p> <p>其实上面的业务逻辑中是存在BUG的：QQ无法发送空的消息，所以，如果对方的消息只包含”收到回复”四个字，那么真正运行的时候会报错。</p> <p>因此，要增加额外的逻辑判断和单元测试，来确保这个BUG不会发生。<strong>真正的勇士，自己就会动手。</strong></p> <h2 id="最后">最后</h2> <p>单元测试就是为了确保代码逻辑在小范围内绝对正确的开发行为，很有必要。</p> <p> <strong>单元测试只要Newbe.Mahua提供的接口稳定，自己的业务逻辑没有变化，那么你的业务逻辑就永远能够通过单元测试。也就是说，这段代码就是为了确保你有底气说出：”我的代码不可能出错！”</strong> </p> <p>以上演示代码，均可以在本项目代码仓库中找到。</p> <h1 id="调试">调试</h1> <p>单元测试是开发阶段最初的测试，但事实是，绝大多数的人更喜欢”跑一下看看”。因此调试，也就很有必要。</p> <h2 id="构建">构建</h2> <p>在构建脚本<code class="highlighter-rouge">build.ps1</code>中，将<code class="highlighter-rouge">$configuration</code>从<code class="highlighter-rouge">Release</code>改为<code class="highlighter-rouge">Debug</code>，然后运行<code class="highlighter-rouge">build.bat</code>完成构建。</p> <p> <img src="/assets/i/20171225-003.png" alt="修改构建参数"/> </p> <h2 id="复制">复制</h2> <p>将生成的所有内容复制到对应机器人平台。</p> <h2 id="启动调试">启动调试</h2> <p>修改项目属性中的调试选项卡配置，并且将插件项目设置为启动项目，F5启动调试，下断点，命中，就这么简单。</p> <p> <img src="/assets/i/20171225-004.png" alt="修改调试启动项目"/> </p> <h2 id="调试框架源码">调试框架源码</h2> <p>从 1.6 版本开始，使用 VS 2017.5 及以上的版本，将可以实现无需下载源码，便可以调试源码的目的，只需要在VS中打开下图设置即可。</p> <p> <img src="/assets/i/20171230-001.png" alt="开启源链接支持"/> </p> <p>至此，调试便可以正常进行了。</p> <p>=========================更多内容分割线=========================</p> <h1 id="教程链接">教程链接</h1> <p> <a href="/docs/mahua/2018/04/21/Begin-First-Plugin-With-Mahua-In-v1.8.html">开始第一个QQ机器人【适用于v1.8及以上】</a> </p> <p> <a href="/docs/mahua/2018/01/07/Newbe-Mahua-ApiExtensions.html">Newbe.Mahua.Samples.ApiExtensions 对IMahuaApi进行扩展</a> </p> <p> <a href="/docs/mahua/2017/12/31/Newbe-Mahua-Samples-LiveGirl.html">Newbe.Mahua.Samples.LiveGirl 操作定时任务</a> </p> <p> <a href="/docs/mahua/2017/12/30/Newbe-Mahua-Samples-Sqlite.html">Newbe.Mahua.Samples.Sqlite SQLite操作实例</a> </p> <p> <a href="/docs/mahua/2017/12/25/Newbe-Mahua-Tests.html">Newbe.Mahua 测试与调试</a> </p> <p> <a href="/docs/mahua/2017/12/24/Newbe-Mahua-Administration.html">Newbe.Mahua 扩展设置中心</a> </p> <h1 id="发布说明">发布说明</h1> <p> <a href="/docs/mahua/releasenodes/2018/04/21/Release-Notes-1-8-0.html">Newbe.Mahua 1.8 消息发送Fluent API</a> </p> <p> <a href="/docs/mahua/releasenodes/2018/01/07/Release-Notes-1-7-0.html">Newbe.Mahua 1.7.0 支持API扩展</a> </p> <p> <a href="/docs/mahua/releasenodes/2017/12/30/Release-Notes-1-6-0.html">Newbe.Mahua 1.6.0 开发便利性提升</a> </p> </div> </article> <hr class="am-print-hide"/> <div class="am-g blog-article-widget blog-article-margin am-print-hide"> <div class="am-u-lg-4 am-u-md-5 am-u-sm-7 am-u-sm-centered blog-text-center"> <span class="am-icon-tags"> &nbsp;</span> <a href="#">Mahua</a> <a href="#">CQP</a> <a href="#">Amanda</a> <a href="#">MPQ</a> <a href="#">SDK</a> <hr> <a href="http://wpa.qq.com/msgrd?v=3&uin=472158246&site=qq&menu=yes" target="_blank"><span class="am-icon-qq am-icon-fw am-primary blog-icon blog-icon"></span></a> <a href="https://github.com/Newbe36524" target="_blank"><span class="am-icon-github am-icon-fw blog-icon blog-icon"></span></a> <a href="http://weibo.com/newbe36524" target="_blank"><span class="am-icon-weibo am-icon-fw blog-icon blog-icon"></span></a> <a href="http://git.oschina.net/yks" target="_blank"><span class="am-icon-reddit am-icon-fw blog-icon blog-icon"></span></a> </div> </div> <div class="am-print-hide"> <div id="SOHUCS" sid="/docs/mahua/2017/12/25/Newbe-Mahua-Tests"></div> <script type="text/javascript">!function(){var t="cytpQ7o5c",e="prod_d85e287b64f481565533e63604638674";(window.innerWidth||document.documentElement.clientWidth)<960?window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id='+t+"&conf="+e+'" />'):function(t,e){var n=document.getElementsByTagName("head")[0]||document.head||document.documentElement,a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("charset","UTF-8"),a.setAttribute("src",t),"function"==typeof e&&(window.attachEvent?a.onreadystatechange=function(){var t=a.readyState;"loaded"!==t&&"complete"!==t||(a.onreadystatechange=null,e())}:a.onload=e),n.appendChild(a)}("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:t,conf:e})})}();</script> </div> </div> <div class="am-u-md-4 am-u-sm-12 blog-sidebar am=print-hide"> <div class="blog-sidebar-widget blog-bor am-hide-sm-only" id="contentsContainer"> <table id="contentsDiv" style="text-align:left"></table> </div> </div> </div> <div data-am-widget="gotop" class="am-gotop am-gotop-fixed am-print-hide"> <a href="#top" title="回到顶部"> <span class="am-gotop-title">回到顶部</span> <i class="am-gotop-icon am-icon-chevron-up"></i> </a> </div> <footer class="blog-footer am-print-hide"> <div class="am-g am-g-fixed blog-fixed am-u-sm-centered blog-footer-padding"> <div class="am-u-sm-12 am-u-md-4- am-u-lg-4"> <h3>友情链接</h3> <a target="_blank" href="https://traceless.site/"><p class="am-text-sm">.Net全栈工程师traceless</p></a> <a target="_blank" href="https://my.suwaworld.xyz/"><p class="am-text-sm">神秘の领域SuwaWorld</p></a> <a target="_blank" href="http://i.qmrobot.com/"><p class="am-text-sm">全能大佬Byboy</p></a> </div> <div class="am-u-sm-12 am-u-md-4- am-u-lg-4"> <h3>社交账号</h3> <p> <a href="http://wpa.qq.com/msgrd?v=3&uin=472158246&site=qq&menu=yes" target="_blank"><span class="am-icon-qq am-icon-fw am-primary blog-icon blog-icon"></span></a> <a href="https://github.com/Newbe36524" target="_blank"><span class="am-icon-github am-icon-fw blog-icon blog-icon"></span></a> <a href="http://weibo.com/newbe36524" target="_blank"><span class="am-icon-weibo am-icon-fw blog-icon blog-icon"></span></a> <a href="http://git.oschina.net/yks" target="_blank"><span class="am-icon-reddit am-icon-fw blog-icon blog-icon"></span></a> </p> <h3>Bio</h3> <p>Newbe便是新生，唯有不断蜕变才能焕然新生。</p> </div> <div class="am-u-sm-12 am-u-md-4- am-u-lg-4"> <h1>我们站在巨人的肩膀上</h1> <h3>Heroes</h3> <p> <ul> <li>amazeui</li> <li>amwiki</li> <li>jekyll</li> <li>Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a></li> <li>...</li> </ul> </p> </div> </div> <div class="blog-text-center"> © 2018 Newbe <a href="http://www.miitbeian.gov.cn" title="闽ICP备18002256号" target="_blank">闽ICP备18002256号</a> <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=35010202000749"> <img src="https://ss0.bdstatic.com/5aV1bjqh_Q23odCf/static/superman/img/icon-police.png?v=md5"/> 闽公网安备 35010202000749号 </a> </div> </footer> <div class="am-modal am-modal-confirm" tabindex="-1" id="live-confirm"> <div class="am-modal-dialog"> <div class="am-modal-hd">b站直播</div> <div class="am-modal-bd"> 听说正在直播码字，要不要前去帮忙刷一下人气？ </div> <div class="am-modal-footer"> <span class="am-modal-btn am-btn-primary" data-am-modal-cancel>滚蛋</span> <span class="am-modal-btn" data-am-modal-confirm>好的</span> </div> </div> </div> <div class="am-modal am-modal-confirm" tabindex="-1" id="giftone-confirm"> <div class="am-modal-dialog"> <div class="am-modal-hd">邀您体验</div> <div class="am-modal-bd"> 限时特惠，现在接受邀请获得QQ机器人免费体验卡！ </div> <div class="am-modal-footer"> <span class="am-modal-btn am-btn-primary" data-am-modal-confirm>OJBK</span> <span class="am-modal-btn" data-am-modal-confirm>就去</span> </div> </div> </div> <!--[if (gte IE 9)|!(IE)]><!--> <script src="https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script> <!--<![endif]--> <!--[if lte IE 8 ]><script src="https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script> <script src="https://cdn.bootcss.com/modernizr/2.8.3/modernizr.min.js"></script> <script src="http://cdn.amazeui.org/amazeui/2.7.2/js/amazeui.ie8polyfill.min.js"></script><![endif]--> <script src="https://cdn.bootcss.com/jquery.pin/1.0.1/jquery.pin.js"></script> <script>$.each($(".am-article-bd img"),function(e,a){$(a).before($('<figure data-am-widget="figure" class="am am-figure am-figure-default" data-am-figure="{ pureview: \'true\' }">').append($(a)[0].outerHTML)),$(a).remove()});</script> <script src="http://cdn.amazeui.org/amazeui/2.7.2/js/amazeui.min.js"></script> <script src="/assets/js/newbe/baidutuisong.js" type="text/javascript"></script> <script type="text/javascript">$(function(){$(".am-article").find("table").addClass("am-table am-table-striped am-table-hover"),$("del").attr("title","\u4f60\u77e5\u9053\u7684\u592a\u591a\u4e86\uff01"),function(){var t=!0;window.setInterval(function(){t||$.get("http://pianzide1117.oicp.net:12821/api/beesite/status").done(function(e){e?($("#live-confirm").modal({relatedTarget:this,onConfirm:function(){window.open("https://live.bilibili.com/7834872")},onCancel:function(){}}),$("#liveStatus").html("\u6b63\u5728\u76f4\u64ad\u7801\u5b57")):($("#liveStatus").html("\u8fd9\u4f1a\u513f\u6ca1\u6709\u76f4\u64ad"),$("#dancedog").hide()),t=!0}).error(function(){$("#liveStatus").html("\u8fd9\u4f1a\u513f\u6ca1\u6709\u76f4\u64ad"),$("#dancedog").hide()})},2e3)}(),function(){var t="giftone";sessionStorage.getItem(t)||window.setTimeout(function(){$("#giftone-confirm").modal({relatedTarget:this,onConfirm:function(){window.open("https://gift.one/i/WIfNmG"),sessionStorage.setItem(t,"loaded")},onCancel:function(){}})},1e4)}(),function(){$("#contentsDiv").html($("#toc").html()),$("#toc").remove(),$("#contentsContainer").pin({containerSelector:".blog-content"})}()});</script> </body> </html>

