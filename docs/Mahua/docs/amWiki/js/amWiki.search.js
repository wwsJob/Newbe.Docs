!function(e){"use strict";var t=function(e){this._storage=e,this.elm={$searchShow:$("#searchShow"),$searchUpdate:this._storage.elm.$searchUpdate,$searchBox:$("#searchBox"),$results:$("#results"),$resultMsg:$("#resultMsg"),$resultMore:$("#resultMore"),$search:$("#search"),$searchText:$("#searchText")},this._data={result:[],template:$("#template\\:searchResult").text(),pageSize:15,pagination:0},this._bindCtrl(),this.onNeedRebuildStorage=null};t.prototype._bindCtrl=function(){var t=this;this.elm.$searchShow.on("click",function(){t.elm.$searchBox.hasClass("on")?(t.displayBox("off"),t.elm.$searchShow.trigger("searchoff")):(t.displayBox("on",function(){s()}),t.elm.$searchShow.trigger("searchon"))});var s=function(){var e=t.elm.$searchBox.height(),s=t.elm.$results.offset().top-t.elm.$searchUpdate.offset().top;t.elm.$results.height(e-s)};$(e).on("resize",function(){t.elm.$searchBox.hasClass("on")&&s()}),this.elm.$searchUpdate.on("click",function(){t._worker&&(t._worker.terminate(),t._worker=null,t.elm.$resultMsg.hide()),t.elm.$search.prop("disabled",!0),t.elm.$searchUpdate.prop("disabled",!0),t.onNeedRebuildStorage(function(){t.elm.$search.prop("disabled",!1),t.elm.$searchUpdate.val("\u8bf7\u52ff\u9891\u7e41\u4f7f\u7528")})});var r=this._storage.getLastBuildTs();if(r){Date.now()-r<36e5&&this.elm.$searchUpdate.prop("disabled",!0).val("\u8bf7\u52ff\u9891\u7e41\u4f7f\u7528")}this.elm.$search.on("click",function(){t._search()}),this.elm.$searchText.on("keyup",function(e){13==e.keyCode&&t._search()}),this.elm.$resultMore.on("click",function(){t._nextResultPage()})},t.prototype.displayBox=function(e,t){var s=this.elm.$searchBox;"on"!=e||s.hasClass("on")?"off"==e&&s.hasClass("on")&&s.removeClass("on").animate({width:"30%",opacity:0},200,"swing",function(){s.removeAttr("style"),t&&t()}):s.addClass("on").css({display:"block",width:"0",opacity:0}).animate({width:"100%",opacity:1},300,"swing",function(){t&&t()})},t.prototype._search=function(){var t=this;if(""==this.elm.$searchText.val())return void this.elm.$searchText.focus();var s=this.elm.$searchText.val();"undefined"!=typeof e.Worker?(this._worker&&(this._worker.terminate(),this._worker=null,this.elm.$resultMsg.hide()),this.elm.$resultMsg.show().text("\u521b\u5efa\u641c\u7d22\u4e2d..."),this._worker=new e.Worker("amWiki/js/amWiki.search.worker.js"),this._worker.onmessage=function(e){var r=e.data;"loaded"==r.type?t._worker.postMessage({type:"docs",docs:t._storage.getAllDocs()}):"ready"==r.type?(t.elm.$resultMsg.show().html("\u6b63\u5728\u641c\u7d22\uff0c\u8bf7\u7a0d\u540e..."),t._worker.postMessage({type:"search",words:s})):"result"==r.type&&(t._data.result=r.result,t._showResultList(),t._worker.terminate(),t._worker=null)},this._worker.onerror=function(e){console.error(e),t._worker.terminate(),t._worker=null}):(this.elm.$resultMsg.show().text("Sorry\uff0c\u60a8\u7684\u6d4f\u89c8\u5668\u4e0d\u652f\u6301\u641c\u7d22\uff01"),this.elm.$search.prop("disabled",!0))},t.prototype._showResultList=function(){this.elm.$results.children("ul").children().remove(),this.elm.$resultMsg.hide(),this._data.pagination=0,this._nextResultPage()},t.prototype._nextResultPage=function(){for(var e,t="",s=0,r=this._data.pagination*this._data.pageSize;(e=this._data.result[r])&&(t+=this._renderRankItem(this._data.template,e),!(++s>=this._data.pageSize));r++);this.elm.$results.children("ul").append(t),this._data.pagination++,this._data.pagination*this._data.pageSize>=this._data.result.length?this.elm.$resultMore.hide():this.elm.$resultMore.show()},t.prototype._renderRankItem=function(t,s){var r=t;s.time=e.tools.formatTime(s.timestamp),delete s.timestamp;for(var a in s)s.hasOwnProperty(a)&&(r=r.replace(new RegExp("{{"+a+"}}","g"),s[a]));return r},e.AWSearch=t}(window);