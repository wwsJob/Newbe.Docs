!function(e,t){"use strict";var a=function(){this.elm={$win:t(e),$testingBox:t("#testingBox"),$view:t("#view"),$sibling:t("#mainSibling"),$testingShow:null,$testingParam:t("#testingParam")},this.data={globalParams:[],globalParamWorking:!0,paramTemplate:t("#template\\:formList").text()},this.request={url:"",method:"",params:[],paramGlobal:[]},this.useGlobalParam(),this.bindPanelCtrl(),this.bindAjaxSend()};a.prototype.crawlContent=function(){var e=this,a=[!1,!1,!1];this.elm.$testingShow.removeClass("show"),this.elm.$view.find("h3").each(function(){var s=t(this),i=t.trim(s.text());if("\u8bf7\u6c42\u5730\u5740"!=i||a[0])if("\u8bf7\u6c42\u7c7b\u578b"!=i||a[1])"\u8bf7\u6c42\u53c2\u6570"!=i||a[2]||(e.request.params.length=0,s.next("table").length>0&&s.next("table").find("tbody").find("tr").each(function(){var a=t(this).find("td"),s={keyName:a.eq(0).text().replace(/^\s+|\s+$/g,""),valueType:a.eq(1).text().replace(/^\s+|\s+$/g,""),required:a.eq(2).text().replace(/^\s+|\s+$/g,""),describe:a.eq(3).text().replace(/^\s+|\s+$/g,""),"default":a.eq(4).text().replace(/^\s+|\s+$/g,""),reference:a.eq(5).text().replace(/^\s+|\s+$/g,"")};"\u65e0"!=s.keyName&&"-"!=s.keyName&&""!=s.keyName&&("\u662f"==s.required||"\u5fc5\u586b"==s.required||"yes"==s.required||"true"==s.required?s.required="required":s.required="","-"!=s["default"]&&"\u65e0"!=s["default"]&&"Null"!=s["default"]&&"null"!=s["default"]||(s.reference&&"-"!=s.reference&&"\u65e0"!=s.reference&&"Null"!=s.reference&&"null"!=s.reference?s["default"]=s.reference:s["default"]=""),e.request.params.push(s))}),a[2]=!0);else{e.request.method=t.trim(s.next().text()).toUpperCase();var l=!1;["GET","POST","PUT","DELETE"].forEach(function(t){e.request.method==t&&(l=!0)}),l||(e.request.method="POST"),a[1]=!0}else e.request.url=t.trim(s.next().text()),e.request.url.indexOf("http")<0&&(0==e.request.url.indexOf("/")?e.request.url="http://"+location.host+e.request.url:e.request.url="http://"+location.host+"/"+e.request.url),a[0]=!0}),a[0]&&a[1]&&a[2]?this.initPanel():this.offPanel(),a=[!1,!1,!1]},a.prototype.offPanel=function(){this.elm.$testingShow.removeClass("show"),this.elm.$testingShow.hasClass("on")&&this.displayBox("off"),this.request.url="",this.request.method="",this.request.params=[],t("#testingSendUrl").val(""),t("#testingSendType").find('option[value="POST"]').prop("selected",!0),this.elm.$testingParam.html(""),t("#testingResponse")[0].contentWindow.location.reload()},a.prototype.initPanel=function(){if(this.elm.$testingShow.addClass("show"),t("#testingSendUrl").val(this.request.url),t("#testingSendType").find('option[value="'+this.request.method+'"]').prop("selected",!0),this.elm.$testingParam.html(""),this.request.params.length>0){for(var e="",a=0;a<this.request.params.length;a++)e+=this.data.paramTemplate.replace("{{describe}}",this.request.params[a].describe).replace("{{keyName}}",this.request.params[a].keyName).replace("{{default}}",this.request.params[a]["default"]).replace("{{valueType}}",this.request.params[a].valueType).replace("{{required}}",this.request.params[a].required);this.elm.$testingParam.append(e)}else this.elm.$testingParam.append("<li>\u65e0</li>")},a.prototype.displayBox=function(e){var t=this;"off"==e?(this.elm.$testingShow.removeClass("on").find("span").text("\u6d4b\u8bd5\u63a5\u53e3"),this.elm.$testingBox.css({position:"absolute"}),this.elm.$view.show().addClass("scroller-content"),this.elm.$sibling.addClass("scroller-content").addClass("on"),this.elm.$testingBox.removeClass("scroller-content").stop().animate({width:"30%",opacity:0},200,"swing",function(){t.elm.$testingBox.removeAttr("style")})):"on"==e&&(this.elm.$testingShow.addClass("on").find("span").text("\u5173\u95ed\u6d4b\u8bd5"),this.elm.$testingBox.css({display:"block",width:"0",opacity:0}).stop().animate({width:"100%",opacity:1},300,"swing",function(){t.elm.$view.hide().removeClass("scroller-content"),t.elm.$sibling.removeClass("scroller-content").removeClass("on"),t.elm.$testingBox.addClass("scroller-content").css({position:"relative"})}))},a.prototype.bindPanelCtrl=function(){var e=this;this.elm.$testingShow=t('<div class="testing-show">[<span>\u6d4b\u8bd5\u63a5\u53e3</span>]</div>'),t("#main").append(this.elm.$testingShow),this.elm.$testingShow.on("click",function(){e.elm.$testingShow.hasClass("on")?e.displayBox("off"):e.displayBox("on")}),t("#testingSendUrl").on("change",function(){e.request.url=t(this).val()}),t("#testingSendType").on("change",function(){e.request.method=t(this).find("option:selected").val()}),t("#testingBtnReset").on("click",function(){e.elm.$testingParam.find(".testing-param-val").val("")}),t("#testingBtnAdd").on("click",function(){var t=e.data.paramTemplate.replace("{{describe}}","\u65b0\u589e\u53c2\u6570").replace("{{keyName}}","").replace("{{default}}","").replace("({{valueType}})","").replace("{{required}}","");e.elm.$testingParam.append(t)})},a.prototype.useGlobalParam=function(){var e=this;this.data.globalParams=JSON.parse(localStorage.amWikiGlobalParam||"[]");var a=t("#template\\:globalParam").text(),s=t("#testingGlobalParam"),i=t("#testingGlobal");this.data.globalParamWorking="on"==(localStorage.amWikiGParamWorking||"on"),t("#testingBtnGParam").on("click",function(){if(s.html(""),e.data.globalParams=JSON.parse(localStorage.amWikiGlobalParam||"[]"),0==e.data.globalParams.length)s.append('<li data-type="empty">\u65e0</li>');else for(var t=0;t<e.data.globalParams.length;t++)s.append(a.replace("{{describe}}",e.data.globalParams[t].describe).replace("{{keyName}}",e.data.globalParams[t].keyName).replace("{{value}}",e.data.globalParams[t].value));i.show()}),i.on("click",function(l){var n=t(l.target);n.hasClass("close")||n.hasClass("testing-global")?i.hide():n.hasClass("add")?(s.find('[data-type="empty"]').remove(),s.append(a.replace("{{describe}}","").replace("{{keyName}}","").replace("{{value}}",""))):n.hasClass("save")&&(e.data.globalParams.length=0,s.find("li").each(function(){var a=t(this).find("input");a.eq(1).val()&&e.data.globalParams.push({describe:a.eq(0).val(),keyName:a.eq(1).val(),value:a.eq(2).val()})}),localStorage.amWikiGlobalParam=JSON.stringify(e.data.globalParams),i.hide())}),s.on("click","i",function(){t(this).parent().remove(),0==s.find("li").length&&s.append('<li data-type="empty">\u65e0</li>')}),t("#testingGlobalWorking").on("click",function(){e.data.globalParamWorking?(e.data.globalParamWorking=!1,localStorage.amWikiGParamWorking="off",t(this).addClass("off")):(e.data.globalParamWorking=!0,localStorage.amWikiGParamWorking="on",t(this).removeClass("off"))}).addClass(this.data.globalParamWorking?"":"off")},a.prototype.bindAjaxSend=function(){var a=this,s=t("#testingResponse")[0],i=t("#testingDuration"),l=t("#testingLoading"),n=t("#testingParam");t("#testingBtnSend").on("click",function(){i.text("");var r={};if(n.find("input").length>0&&n.find("li").each(function(){var e=t(this);r[e.find(".testing-param-key").val()]=e.find(".testing-param-val").val()}),a.data.globalParams.length>0&&a.data.globalParamWorking)for(var o=0;o<a.data.globalParams.length;o++)r[a.data.globalParams[o].keyName]=a.data.globalParams[o].value;s.contentWindow.location.reload(),l.show();var d=Date.now();t.ajax({type:a.request.method,url:a.request.url,data:r,dataType:"text",success:function(a){l.hide(),i.text("\u8017\u65f6\uff1a"+parseFloat(Date.now()-d).toLocaleString()+" ms");var n=t(s.contentWindow.document).find("body");n.css("wordBreak","break-all"),/^\s*\{[\s\S]*\}\s*$/.test(a)?(n[0].innerHTML='<pre style="white-space:pre-wrap;word-break:break-all;"><pre>',n.find("pre").text(e.tools.formatJson(a))):n[0].innerHTML=a.replace(/<!(doctype|DOCTYPE)\s+(html|HTML)>/,""),setTimeout(function(){t(s).height(n.height())},100)},error:function(a){l.hide(),i.text("\u8017\u65f6\uff1a"+parseFloat(Date.now()-d).toLocaleString()+" ms");var n=t(s.contentWindow.document).find("body");n.css("wordBreak","break-all");var r='<div style="margin-bottom:20px;padding:10px;background:#ffebe5;">HTTP Status: <b>'+a.status+"</b> "+a.statusText+"</div>";0==a.readyState?(r+='<div style="font-size:14px;">\u8bf7\u6c42\u672a\u53d1\u9001\uff01\u53ef\u80fd\u662f\u56e0\u4e3a\uff1a<ul style="line-height:22px;"><li>\u8bf7\u6c42\u4e86<b style="color:#FF201E;margin-right:1px;">\u8de8\u57df</b>\u5730\u5740</li><li>\u63a5\u53e3\u88ab302\u91cd\u5b9a\u5411\u5230\u8de8\u57df\u5730\u5740</li><li>\u5176\u4ed6\u539f\u56e0</li></ul></div>',n[0].innerHTML=r):/^\s*\{[\s\S]*\}\s*$/.test(a.responseText)?(r+='<pre style="white-space:pre-wrap;word-break:break-all;"><pre>',n[0].innerHTML=r,n.find("pre").text(e.tools.formatJson(a.responseText))):(r+=a.responseText.replace(/<!(doctype|DOCTYPE)\s+(html|HTML)>/,""),n[0].innerHTML=r),setTimeout(function(){t(s).height(n.height())},100)}})})},a.prototype.isOpen=function(){return this.elm.$testingShow.hasClass("on")},e.AWTesting=a}(window,jQuery);